<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS 系統</title>

<style>
/* ===== 基礎樣式 ===== */
body { margin:0; font-family:"Microsoft JhengHei", sans-serif; background:#f0f0f0; }

/* ===== 登入 modal ===== */
#loginModal {
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);
  display:flex;justify-content:center;align-items:center;
  z-index:9999;
}
#loginBox {
  background:white;padding:25px;border-radius:12px;width:320px;text-align:center;
}
#loginBox input {
  width:90%;padding:10px;margin:6px 0;font-size:16px;
}

/* ===== 主畫面排版 ===== */
#mainPOS { display:none; padding:10px; }

/* 商品分類 */
#posCategories button {
  margin:3px;padding:6px 10px;border:1px solid #666;border-radius:6px;background:white;
}
#posCategories .active { background:#007bff;color:white; }

/* 商品清單 */
#posProducts {
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;
}
.product-card {
  background:white;padding:6px;border-radius:8px;text-align:center;
  box-shadow:0 1px 4px rgba(0,0,0,0.15);
}
.product-card img { width:100%;height:80px;object-fit:cover;border-radius:6px; }

/* 購物車 */
.cartRow {
  display:grid;grid-template-columns:2fr 1fr 1fr 1fr 40px;
  gap:6px;padding:6px;background:white;border-radius:6px;margin-top:5px;
  align-items:center; font-size:15px;
}
.cartRow span button { background:red;color:white;border:none;border-radius:5px;padding:5px; }

/* 結帳按鈕 */
#posCheckout { width:100%;padding:15px;font-size:20px;margin-top:10px;background:#ff9800;color:white;border:none;border-radius:10px; }

/* Checkout Modal */
#checkoutModal {
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;
  z-index:10000;
}
#checkoutContent {
  background:white;padding:20px;border-radius:12px;width:300px;text-align:left;
}

/* 交班區塊 */
#shiftBox {
  display:none;background:white;padding:20px;border-radius:10px;margin-top:20px;
}

</style>
</head>
<body>
<!-- ========================= -->
<!-- POS 主畫面區塊 -->
<!-- ========================= -->
<div id="mainPOS">

  <!-- 商品分類 -->
  <h2>商品分類</h2>
  <div id="posCategories"></div>

  <!-- 搜尋商品 -->
  <input id="searchBox" placeholder="搜尋商品..." 
    style="width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ccc;">

  <!-- 商品列表 -->
  <div id="posProducts"></div>

  <hr>

  <!-- 購物車 -->
  <h2>購物車</h2>
  <div id="posCart"></div>

  <!-- 折扣 -->
  <div style="margin-top:10px;">
    <label>整單折扣：</label>
    <input id="discount" value="0" style="width:80px;">
  </div>

  <!-- 稅別 -->
  <div style="margin-top:10px;">
    <button id="taxIncluded" class="active" onclick="setTax('應稅')">應稅</button>
    <button id="taxExempt" onclick="setTax('免稅')">免稅</button>
  </div>

  <!-- 稅金 -->
  <div style="margin-top:10px;">稅金：<span id="taxAmount">0</span> 元</div>

  <!-- 總金額 -->
  <h3 style="margin-top:10px;">應付總額：<span id="posTotal">0</span> 元</h3>

  <!-- 付款方式 -->
  <select id="posPayment" style="width:100%;padding:10px;border-radius:8px;margin-top:10px;">
    <option>現金</option>
    <option>LINE PAY</option>
    <option>信用卡</option>
  </select>

  <!-- 收現（只在現金顯示） -->
  <div style="margin-top:10px;">
    <label>收現：</label>
    <input id="cashInput" value="0" style="width:120px;">
  </div>

  <!-- 找零 -->
  <div style="margin-top:10px;">找零：<span id="changeOut">0</span> 元</div>

  <!-- 結帳 -->
  <button id="posCheckout">結帳</button>

  <hr style="margin-top:20px;">

  <!-- ========================= -->
  <!-- 交班 / 當日統計 -->
  <!-- ========================= -->
  <h2>當日結帳統計</h2>
  <div id="shiftBox">
    <p>日期：<span id="shiftDate"></span></p>
    <p>門市：<span id="shiftStore"></span></p>
    <p>現金：<span id="shiftCash">0</span> 元</p>
    <p>LINE Pay：<span id="shiftLine">0</span> 元</p>
    <p>信用卡：<span id="shiftCard">0</span> 元</p>
    <p>訂單數：<span id="shiftCount">0</span></p>

    <button onclick="loadShiftSummary()" 
      style="padding:12px;width:100%;background:#4caf50;color:white;border:none;border-radius:10px;">
      更新今日統計
    </button>
  </div>

</div> <!-- end mainPOS -->


<!-- ========================= -->
<!-- 結帳明細 Modal -->
<!-- ========================= -->
<div id="checkoutModal">
  <div id="checkoutContent"></div>
</div>


<!-- ========================= -->
<!-- JS 區塊（下一段提供完整 JS） -->
<!-- ========================= -->
<script>

// =============================
// 全域變數
// =============================
const API_URL = "https://script.google.com/macros/s/AKfycbzf08JICLa1fFzjCAFiqGH8dXWtyc6Z-v1zg834RIYpkfbBIw4s05JodxhBk5p4G3EI/exec";

let products = [];
let categories = [];
let posCart = [];
let currentTax = "應稅";

let currentStore = "";
let currentPosId = "";
let currentUserId = "";
let currentUserName = "";

// =============================
// 取得 IP
// =============================
async function getIP(){
  const r = await fetch("https://api.ipify.org?format=json");
  return (await r.json()).ip;
}

// =============================
// 依 IP 自動抓分店
// =============================
async function resolveStore(){
  const ip = await getIP();
  let r = await fetch(`${API_URL}?action=resolveStoreByIP&ip=${ip}`);
  let j = await r.json();

  if(j.status === "success"){
    currentStore = j.store;
    currentPosId = j.posId;
    document.getElementById("autoStore").innerText = j.store;
  } else {
    document.getElementById("autoStore").innerText = "IP 未註冊";
  }
}
resolveStore();

// =============================
// 登入
// =============================
async function doLogin(){
  const user = document.getElementById("loginUser").value;
  const pass = document.getElementById("loginPass").value;
  const ip = await getIP();

  const r = await fetch(`${API_URL}?action=login&userId=${user}&password=${pass}&ip=${ip}`);
  const j = await r.json();

  if(j.status === "success"){
    currentStore = j.store;
    currentPosId = j.posId;
    currentUserId = j.userId;
    currentUserName = j.userName;

    // 儲存至 localStorage
    localStorage.setItem("store", currentStore);
    localStorage.setItem("posId", currentPosId);
    localStorage.setItem("userId", currentUserId);
    localStorage.setItem("userName", currentUserName);

    // 顯示主畫面
    document.getElementById("loginModal").style.display = "none";
    document.getElementById("mainPOS").style.display = "block";

    // 載入商品
    fetchProducts();
  } else {
    alert(j.message);
  }
}

// =============================
// 載入商品
// =============================
async function fetchProducts(){
  const r = await fetch(`${API_URL}?action=products&store=${currentStore}`);
  products = await r.json();

  categories = [...new Set(products.map(p => p["類別"]))];
  renderCategories();
  renderProducts(categories[0]);
}

// =============================
// 渲染商品分類
// =============================
function renderCategories(){
  const box = document.getElementById("posCategories");
  box.innerHTML = "";

  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent = cat;

    btn.onclick = ()=>{
      document.querySelectorAll("#posCategories button")
        .forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };

    box.appendChild(btn);
  });

  box.querySelector("button").classList.add("active");
}

// =============================
// 搜尋商品
// =============================
document.getElementById("searchBox").oninput = function(){
  renderProducts(null, this.value.toLowerCase());
};

// =============================
// 渲染商品卡片
// =============================
function renderProducts(category=null, search=""){
  const box = document.getElementById("posProducts");
  box.innerHTML = "";

  products
    .filter(p=>{
      if(category && p["類別"] !== category) return false;
      if(search && !p["商品名稱"].toLowerCase().includes(search)) return false;
      return true;
    })
    .forEach(p=>{
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <img src="${p["商品照片"]}">
        <h4>${p["商品名稱"]}</h4>
        <p>${p["售價"]} 元 / ${p["單位"]}</p>
      `;
      card.onclick = ()=>addPOSItem(p);
      box.appendChild(card);
  });
}

// =============================
// 加入購物車
// =============================
function addPOSItem(p){
  let qty = 1;
  let price = Number(p["售價"]);
  let unit = p["單位"];

  if(unit === "半斤"){
    qty = 0.5;
    price *= 2; // 半斤 → 換算成 1斤價格
    unit = "斤";
  }

  let exist = posCart.find(x=>x.name === p["商品名稱"]);
  if(exist) exist.quantity += qty;
  else posCart.push({
    name: p["商品名稱"],
    quantity: qty,
    price: price,
    unit: unit,
    category: p["類別"],
    discount: null
  });

  renderCart();
}

// =============================
// 渲染購物車
// =============================
function renderCart(){
  const box = document.getElementById("posCart");
  box.innerHTML = "";

  let total = 0;

  posCart.forEach((item,i)=>{
    let sub = item.quantity * item.price;

    if(item.discount){
      switch(item.discount.type){
        case "第二件減10":
          sub -= Math.floor(item.quantity/2)*10;
          break;
        case "買一送一":
          sub -= Math.floor(item.quantity/2)*item.price;
          break;
        case "買二送一":
          sub -= Math.floor(item.quantity/3)*item.price;
          break;
        case "第二件6折":
          sub -= Math.floor(item.quantity/2)*item.price*0.4;
          break;
        default:
          sub *= item.discount.rate || 1;
      }
    }

    total += sub;

    const row = document.createElement("div");
    row.className = "cartRow";
    row.innerHTML = `
      <span class="name" onclick="openPromoModal(${i})">${item.name}</span>
      <span class="qty" onclick="openNumEdit(${i}, 'quantity')">${item.quantity.toFixed(2)}</span>
      <span class="price" onclick="openNumEdit(${i}, 'price')">${item.price}</span>
      <span class="subtotal">${sub.toFixed(0)}</span>
      <span class="remove"><button onclick="removeItem(${i})">刪</button></span>
    `;
    box.appendChild(row);
  });

  let discount = Number(document.getElementById("discount").value)||0;
  let taxBase = total - discount;
  let tax = currentTax==="應稅" ? taxBase*0.05 : 0;

  document.getElementById("taxAmount").innerHTML = tax.toFixed(0);
  document.getElementById("posTotal").innerHTML = (taxBase + tax).toFixed(0);

  updateChange();
}

// =============================
// 刪除購物車項目
// =============================
function removeItem(i){
  posCart.splice(i,1);
  renderCart();
}

// =============================
// 數字鍵盤/數值編輯（簡化版）
// =============================
function openNumEdit(index, field){
  let v = prompt("輸入新的數值：", posCart[index][field]);
  if(v !== null){
    posCart[index][field] = Number(v);
    renderCart();
  }
}

// =============================
// 優惠 Modal（簡化成 prompt 選擇）
// =============================
function openPromoModal(i){
  const item = posCart[i];
  const list = [
    "95折","9折","85折","8折","7折","6折",
    "買一送一","買二送一","第二件減10","第二件6折","清除優惠"
  ];

  let sel = prompt("選擇優惠:\n" + list.join("\n"));
  if(!sel) return;

  if(sel === "清除優惠"){
    item.discount = null;
  } else if(sel.includes("折") && sel.length<=3){
    let rate = parseFloat(sel)/100;
    item.discount = {rate:rate,type:"折扣"};
  } else {
    item.discount = {type:sel};
  }

  renderCart();
}

// =============================
// 稅別
// =============================
function setTax(t){
  currentTax = t;
  document.getElementById("taxIncluded").classList.toggle("active", t==="應稅");
  document.getElementById("taxExempt").classList.toggle("active", t==="免稅");
  renderCart();
}

// =============================
// 找零計算
// =============================
function updateChange(){
  const cash = Number(document.getElementById("cashInput").value)||0;
  const total = Number(document.getElementById("posTotal").innerText)||0;
  document.getElementById("changeOut").innerHTML = Math.max(0, cash-total).toFixed(0);
}

// =============================
// 結帳
// =============================
document.getElementById("posCheckout").onclick = async function(){
  const total = Number(document.getElementById("posTotal").innerText)||0;
  const discount = Number(document.getElementById("discount").value)||0;
  const tax = Number(document.getElementById("taxAmount").innerText)||0;

  const body = {
    store: currentStore,
    posId: currentPosId,
    userId: currentUserId,
    userName: currentUserName,
    discount: discount,
    tax: tax,
    paymentMethod: document.getElementById("posPayment").value,
    items: posCart
  };

  const r = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(body)
  });

  const j = await r.json();

  if(j.status==="success"){
    document.getElementById("checkoutContent").innerHTML =
      `<h3>結帳成功！</h3>單號：${j.orderId}`;
    document.getElementById("checkoutModal").style.display = "flex";

    posCart = [];
    renderCart();
  } else {
    alert("結帳失敗：" + j.message);
  }
};

// =============================
// 關閉結帳 Modal
// =============================
document.getElementById("checkoutModal").onclick = function(){
  this.style.display = "none";
};

// =============================
// 交班統計
// =============================
async function loadShiftSummary(){
  let d = new Date();
  let dateStr = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;

  const r = await fetch(`${API_URL}?action=dailySummary&store=${currentStore}&date=${dateStr}`);
  const j = await r.json();

  document.getElementById("shiftDate").innerText = dateStr;
  document.getElementById("shiftStore").innerText = currentStore;

  document.getElementById("shiftCash").innerText = j.totalCash;
  document.getElementById("shiftLine").innerText = j.totalLinePay;
  document.getElementById("shiftCard").innerText = j.totalCredit;
  document.getElementById("shiftCount").innerText = j.orderCount;

  document.getElementById("shiftBox").style.display = "block";
}

</script>
</body>
</html>













