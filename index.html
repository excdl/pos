<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台灣生鮮 POS 系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#posApp{display:flex;height:100vh;}
#posCategories{width:18%;background:#3498db;padding:15px;color:white;overflow-y:auto;border-radius:0 12px 12px 0;}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#posProducts{flex:1;padding:15px 0 15px 5%;display:flex;flex-wrap:wrap;gap:15px;justify-content:flex-start;align-content:flex-start;overflow-y:auto;}
.product-card{background:white;border-radius:12px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;justify-content:flex-start;text-align:center;transition:0.3s;cursor:pointer;width:120px;height:200px;flex-shrink:0;}
.product-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,0.15);}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:5px;}
.product-card h4{margin:0;font-size:0.6em;line-height:1.2em;white-space:normal;word-wrap:break-word;max-height:2.4em;overflow:hidden;text-overflow:ellipsis;}
.product-card p{margin:2px 0 0 0;font-size:0.8em;color:#555;}
#posCartContainer{width:27%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;border-left:2px solid #ddd;}
.cartHeader{font-weight:bold;background:#eee;font-size:80%;display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr;gap:5px;padding:5px;border-radius:6px;text-align:center;}
#posCart div.cartRow{display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr;gap:5px;background:white;padding:5px;margin-bottom:5px;border-radius:6px;align-items:center;text-align:center;font-size:0.75em;}
#posCart div.cartRow span.name{text-align:left;cursor:pointer;}
#discountContainer{display:flex;gap:5px;margin:5px 0;}
#discountContainer input{flex:1;padding:6px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:0.9em;cursor:pointer;}
#taxContainer{display:flex;flex-wrap:wrap;gap:5px;margin:5px 0;}
#taxContainer button{flex:1 1 30%;padding:6px;border:none;border-radius:6px;background:#bdc3c7;cursor:pointer;}
#taxContainer button.active{background:#f1c40f;color:#333;font-weight:bold;}
#cashPanel{display:block;margin-top:5px;}
#cashPanel input{width:100%;padding:8px;margin-top:5px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:1em;cursor:pointer;}
#posCheckout{margin-top:8px;padding:12px;font-size:1.2em;background:#27ae60;color:white;border:none;border-radius:6px;}
#editModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#editModal .modalContent{background:white;padding:20px;border-radius:12px;width:90%;max-width:350px;text-align:center;}
#editModal input{width:80%;font-size:1.4em;text-align:center;border:2px solid #ccc;border-radius:6px;margin:8px 0;}
#numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:5px;}
#numpad button{padding:15px;background:#3498db;color:white;font-size:1.2em;border:none;border-radius:6px;}
#promoButtons{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:10px;}
#promoButtons button{padding:8px;background:#3498db;color:white;font-size:0.9em;border:none;border-radius:6px;}
.modalActions{display:flex;gap:5px;margin-top:10px;}
.modalActions button{flex:1;padding:10px;border:none;border-radius:6px;}
.confirm{background:#27ae60;color:white;}
.cancel{background:#e74c3c;color:white;}
.convert{background:#f39c12;color:white;}
@media (max-width:600px){
  #numpad button{padding:20px;font-size:1.5em;}
  #editModal input{font-size:1.8em;}
}
#editModal.promoMode #modalInput {display: none !important; margin: 0 !important; padding: 0 !important; height: 0 !important;}  
#printArea{display:none;width:58mm;font-size:12px;line-height:1.2em;}
#printArea h4{text-align:center;margin:2px 0;}
#printArea table{width:100%;border-collapse:collapse;}
#printArea td{text-align:left;}
#printArea td.right{text-align:right;}
</style>
</head>
<body>

<!-- 登入頁面 -->
<div id="loginPage" style="display:flex;justify-content:center;align-items:center;height:100vh;background:#3498db;">
  <div style="background:white;padding:40px 30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);width:320px;text-align:center;">
    <h2 style="margin-bottom:20px;color:#2c3e50;">生鮮 POS 登入</h2>
    <input id="storeInput" placeholder="門市編號" style="width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;font-size:1em;">
    <input id="passwordInput" placeholder="密碼" type="password" style="width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;font-size:1em;">
    <button id="loginBtn" style="width:100%;padding:12px;margin-top:15px;border:none;border-radius:6px;background:#27ae60;color:white;font-size:1em;cursor:pointer;transition:0.2s;">登入</button>
    <p id="loginMsg" style="color:red;margin-top:10px;font-size:0.9em;"></p>
  </div>
</div>

<!-- POS 主頁 -->
<div id="posApp" style="display:none;">
  <!-- POS Header -->
<div id="posHeader" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
  <span id="storeInfo">門市資訊</span>
  <span id="loginTime">登入時間：--</span>
  <div id="todaySalesDisplay" style="font-weight:bold;">今日營業額：0 元</div>
</div>

<!-- POS 功能區 -->
<div id="posApp" style="display:flex; flex-direction:column;">
  <!-- 商品分類 -->
  <div id="posCategories" style="display:flex; gap:5px; margin-bottom:10px;"></div>

  <!-- 搜尋框 -->
  <input type="text" id="searchBox" placeholder="搜尋商品..." style="margin-bottom:10px;">

  <!-- 商品列表 -->
  <div id="posProducts" style="display:flex; flex-wrap:wrap; gap:10px;"></div>

  <!-- 購物車 -->
  <div id="posCart" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"></div>

  <!-- POS 下方操作 -->
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="number" id="discount" value="0" placeholder="折扣" style="width:80px;">
    <select id="posPayment">
      <option>現金</option>
      <option>信用卡</option>
      <option>Line Pay</option>
    </select>
    <input type="number" id="cashInput" placeholder="收現金" style="width:100px;">
    <span>找零：<span id="changeOut">0</span></span>
    <span>稅金：<span id="taxAmount">0</span></span>
    <span>總額：<span id="posTotal">0</span></span>
    <button id="posCheckout">結帳</button>
  </div>

  <!-- 交班 / 今日營業額按鈕 -->
  <div id="shiftDailyContainer" style="display:flex; gap:10px; margin-top:10px;">
    <button id="shiftEndBtn" style="flex:1; background:#c0392b; color:white; border:none; border-radius:6px; padding:10px;">交班結算</button>
    <button id="todaySalesBtn" style="flex:1; background:#2980b9; color:white; border:none; border-radius:6px; padding:10px;">當日營業額</button>
  </div>
</div>

  
  <!-- 編輯 Modal -->
<div id="editModal">
  <div class="modalContent">
    <h4 id="modalProductName">輸入</h4>
    <input id="modalInput" readonly>
    <div id="numpad">
      <button onclick="np('7')">7</button><button onclick="np('8')">8</button><button onclick="np('9')">9</button>
      <button onclick="np('4')">4</button><button onclick="np('5')">5</button><button onclick="np('6')">6</button>
      <button onclick="np('1')">1</button><button onclick="np('2')">2</button><button onclick="np('3')">3</button>
      <button onclick="np('0')">0</button><button onclick="np('.')">.</button><button onclick="backspace()">←</button>
    </div>
    <div id="promoButtons"></div>
    <div class="modalActions">
      <button class="cancel" onclick="closeModal()">取消</button>
      <button class="confirm" onclick="confirmEdit()">確定</button>
    </div>
  </div>
</div>

<!-- 列印收據區 -->
<div id="printArea"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwGYOcjCbZSFu9UYWXZFXGawpfuEWQWPVFnfxpERzkBcv2RMK4QL2T0imUufHXbQVBp/exec";
  let POS_STORE = "";
  let posCart = [], currentTax = "應稅";
  let products = [], categories = [];

  // ====== 取得 IP (含快取) ======
  async function getIP() {
    const cache = sessionStorage.getItem("myIP");
    if (cache) return cache;
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      sessionStorage.setItem("myIP", data.ip);
      return data.ip;
    } catch { return ""; }
  }

  // ===== 更新登入時間 =====
  function updateLoginTime() {
    const now = new Date();
    const elem = document.getElementById("loginTime");
    if(elem) elem.innerText = `登入時間：${now.toLocaleString("zh-TW",{hour12:false})}`;
  }

  // ===== 登入 =====
  async function login() {
    const loginBtn = document.getElementById("loginBtn");
    if(!loginBtn) return;

    loginBtn.innerText = "登入中...";
    loginBtn.disabled = true;

    const store = document.getElementById("storeInput")?.value || "";
    const pwd = document.getElementById("passwordInput")?.value || "";
    const userIP = await getIP();

    try {
      const res = await fetch(`${API_URL}?action=login&store=${store}&pwd=${pwd}&ip=${userIP}`);
      const data = await res.json();

      if (data.status === "success") {
        POS_STORE = data.storeCode;

        // 隱藏登入頁，顯示 POS
        const loginPage = document.getElementById("loginPage");
        const posApp = document.getElementById("posApp");
        if(loginPage) loginPage.style.display = "none";
        if(posApp) posApp.style.display = "flex";

        document.getElementById("storeInfo").innerText = `${data.storeName}（${data.storeCode}）`;

        updateLoginTime();
        setInterval(updateLoginTime, 1000);

        fetchProducts();
      } else {
        document.getElementById("loginMsg").innerText = data.message;
        loginBtn.innerText = "登入";
        loginBtn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      document.getElementById("loginMsg").innerText = "登入失敗，請稍後再試";
      loginBtn.innerText = "登入";
      loginBtn.disabled = false;
    }
  }

  // ===== 登出 =====
  async function logout() {
    const now = new Date();
    const logoutTime = now.toLocaleString("zh-TW",{hour12:false});
    try { await fetch(`${API_URL}?action=logout&store=${POS_STORE}&time=${encodeURIComponent(logoutTime)}`); } 
    catch(err){ console.error(err); }

    const loginPage = document.getElementById("loginPage");
    const posApp = document.getElementById("posApp");
    if(posApp) posApp.style.display = "none";
    if(loginPage) loginPage.style.display = "flex";

    document.getElementById("storeInput").value = "";
    document.getElementById("passwordInput").value = "";
    document.getElementById("loginMsg").innerText = "";

    const loginBtn = document.getElementById("loginBtn");
    if(loginBtn){ loginBtn.innerText = "登入"; loginBtn.disabled = false; }

    POS_STORE = "";
  }

  // ===== 綁定按鈕事件 =====
  const loginBtn = document.getElementById("loginBtn");
  if(loginBtn) loginBtn.addEventListener("click", login);

  const logoutBtn = document.getElementById("logoutBtn");
  if(logoutBtn) logoutBtn.addEventListener("click", logout);

  const shiftEndBtn = document.getElementById("shiftEndBtn");
  if(shiftEndBtn) shiftEndBtn.addEventListener("click", async () => {
    if (posCart.length > 0 && !confirm("購物車尚有未結帳商品，是否仍交班？")) return;
    const now = new Date();
    const payload = {
      storeCode: POS_STORE,
      storeName: document.getElementById("storeInfo")?.innerText.split("（")[0] || "",
      shiftDate: now.toLocaleDateString("zh-TW"),
      shiftEndTime: now.toLocaleTimeString("zh-TW", { hour12: false })
    };
    try {
      const res = await fetch(API_URL + "?action=shiftEnd", {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      alert("交班成功！本班營業額：" + (data.total || 0) + " 元");
      posCart = [];
      renderCart();
    } catch(err){
      console.error(err);
      alert("交班失敗，請稍後再試");
    }
  });

  const todaySalesBtn = document.getElementById("todaySalesBtn");
  if(todaySalesBtn) todaySalesBtn.addEventListener("click", async () => {
    try {
      const res = await fetch(API_URL + "?action=todaySales&storeCode=" + POS_STORE);
      const data = await res.json();
      alert("今日營業額：" + (data.total || 0) + " 元");

      const display = document.getElementById("todaySalesDisplay");
      if(display) display.innerText = "今日營業額：" + (data.total || 0) + " 元";
    } catch(err){ console.error(err); }
  });

  
// ===== 渲染購物車 =====
function renderCart() {
    const box = document.getElementById("posCart"); box.innerHTML = "";
    let total = 0;
    posCart.forEach((item, i) => {
        let sub = item.quantity * item.price;
        if (item.discount) {
            switch (item.discount.type) {
                case "第二件減10": sub -= Math.floor(item.quantity / 2) * 10; break;
                case "買二送一": sub -= Math.floor(item.quantity / 3) * item.price; break;
                case "買一送一": sub -= Math.floor(item.quantity / 2) * item.price; break;
                case "第二件6折": sub -= Math.floor(item.quantity / 2) * item.price * 0.4; break;
                default: sub *= item.discount.rate || 1; break;
            }
        }
        total += sub;
        const row = document.createElement("div");
        row.className = "cartRow";
        row.innerHTML = `<span class="name" onclick="openPromoModal(posCart[${i}])">${item.name}</span>
            <span class="qty" onclick="openEditModal(${i},'quantity')">${item.quantity.toFixed(2)} ${item.unit}</span>
            <span class="price" onclick="openEditModal(${i},'price')">${item.price}</span>
            <span class="subtotal">${sub.toFixed(0)}</span>
            <span class="remove"><button onclick="removeItem(${i})">刪</button></span>`;
        box.appendChild(row);
    });
    let discountValue = Number(document.getElementById("discount").value) || 0;
    let taxBase = total - discountValue;
    let tax = currentTax === "應稅" ? taxBase * 0.05 : 0;
    document.getElementById("taxAmount").innerText = tax.toFixed(0);
    document.getElementById("posTotal").innerText = (taxBase + tax).toFixed(0);
    updateChange();
}



// ===== 刪除商品 =====
function removeItem(i) { posCart.splice(i, 1); renderCart(); }

// ===== 編輯數量/折扣/收現 =====
document.getElementById("discount").onclick = () => openEditModal(null, 'discount');
document.getElementById("cashInput").onclick = () => openEditModal(null, 'cash');

function openEditModal(index, field) {
    editIndex = index; editingField = field; modalType = field;
    document.getElementById("promoButtons").style.display = 'none';
    document.getElementById("numpad").style.display = 'grid';
    let value = (field === 'discount' ? document.getElementById("discount").value
        : field === 'cash' ? document.getElementById("cashInput").value
            : posCart[index][field]);
    document.getElementById("modalInput").value = value;
    document.getElementById("modalProductName").innerText = field === 'cash' ? '收現金' : field === 'discount' ? '折扣' : '輸入';
    document.getElementById("editModal").style.display = "flex";
}

function openPromoModal(item) {
    modalType = 'promo'; editIndex = null;
    document.getElementById("numpad").style.display = 'none';
    const promoDiv = document.getElementById("promoButtons");
    promoDiv.style.display = 'grid';
    promoDiv.innerHTML = '';
    const promoList = [
        { name: '95折', rate: 0.95 }, { name: '9折', rate: 0.9 }, { name: '85折', rate: 0.85 }, { name: '8折', rate: 0.8 },
        { name: '7折', rate: 0.7 }, { name: '6折', rate: 0.6 }, { name: '買一送一', type: '買一送一' }, { name: '買二送一', type: '買二送一' },
        { name: '第二件減10', type: '第二件減10' }, { name: '第二件6折', type: '第二件6折' }
    ];
    promoList.forEach(p => {
        const btn = document.createElement('button');
        btn.innerText = p.name;
        btn.onclick = () => {
            let idx = posCart.findIndex(x => x.name === item.name);
            if (idx === -1) addPOSItem(item);
            idx = posCart.findIndex(x => x.name === item.name);
            if (p.type) posCart[idx].discount = { type: p.type };
            else posCart[idx].discount = { rate: p.rate, type: '折扣' };
            closeModal(); renderCart();
        };
        promoDiv.appendChild(btn);
    });
    document.getElementById("modalProductName").innerText = item.name;
    document.getElementById("editModal").style.display = 'flex';
    document.getElementById("editModal").classList.add("promoMode");
}

function np(v) {
    let input = document.getElementById("modalInput");
    input.value = (input.value === '0' && v !== '.') ? v : input.value + v;
}

function backspace() {
    let input = document.getElementById("modalInput");
    input.value = input.value.slice(0, -1);
    if (input.value === '') input.value = '0';
}

function confirmEdit() {
    let val = document.getElementById("modalInput").value;
    if (editIndex !== null && editingField === 'quantity' && posCart[editIndex].unit === '斤') {
        const parts = val.split('.');
        let j = Number(parts[0]) || 0;
        let l = Number(parts[1]) || 0;
        let q = Number(parts[2]) || 0;
        let totalQty = j + l / 16 + q / 160;
        posCart[editIndex].quantity = totalQty;
    } else {
        let v = Number(val);
        if (modalType === 'discount') document.getElementById("discount").value = v;
        else if (modalType === 'cash') document.getElementById("cashInput").value = v;
        else if (editIndex !== null) posCart[editIndex][editingField] = v;
    }
    closeModal(); renderCart();
}

function closeModal() {
    document.getElementById("editModal").style.display = 'none';
    editIndex = null; editingField = null; modalType = null;
    document.getElementById("editModal").classList.remove("promoMode");
}

function setTax(t) {
    currentTax = t;
    document.getElementById("taxIncluded").classList.toggle('active', t === "應稅");
    document.getElementById("taxExempt").classList.toggle('active', t === "免稅");
    renderCart();
}

function updateChange() {
    let cash = Number(document.getElementById("cashInput").value) || 0;
    let total = Number(document.getElementById("posTotal").innerText) || 0;
    document.getElementById("changeOut").innerText = Math.max(0, cash - total).toFixed(0);
}

function formatDiscountRate(rate) {
    let d = rate * 100;          // 0.9 → 90
    let s = d.toString();        // "90"

    // 90 → 9, 80 → 8, 70 → 7...
    if (d % 10 === 0) {
        s = (d / 10).toString();
    }
    return s + "折";
}
  
  
function calcDiscountedSubtotal(item) {
    let sub = item.quantity * item.price;
    if (item.discount) {
        switch (item.discount.type) {
            case "第二件減10":
                sub -= Math.floor(item.quantity / 2) * 10;
                break;
            case "買二送一":
                sub -= Math.floor(item.quantity / 3) * item.price;
                break;
            case "買一送一":
                sub -= Math.floor(item.quantity / 2) * item.price;
                break;
            case "第二件6折":
                sub -= Math.floor(item.quantity / 2) * item.price * 0.4;
                break;
            case "折扣":      // 例如 95折、9折
                sub *= item.discount.rate;
                break;
        }
    }
    return Math.round(sub);
}

  async function sendCheckoutToSheet() {

    const now = new Date();

    const payload = {
        orderDate: now.toLocaleDateString("zh-TW"),
        orderTime: now.toLocaleTimeString("zh-TW", { hour12: false }),
        checkoutDateTime: now.toLocaleString("zh-TW", { hour12: false }),

        storeName: document.getElementById("storeInfo").innerText.split("（")[0],
        storeCode: POS_STORE,

        taxStatus: currentTax,
        taxAmount: Number(document.getElementById("taxAmount").innerText),
        totalAmount: Number(document.getElementById("posTotal").innerText),
        paymentMethod: document.getElementById("posPayment").value,
        discount: Number(document.getElementById("discount").value) || 0,
        cashReceive: Number(document.getElementById("cashInput").value) || 0,
        change: Number(document.getElementById("changeOut").innerText) || 0,

        items: posCart.map(it => {

            // ① 小計（折扣後）
            const discountedSubtotal = calcDiscountedSubtotal(it);

            // ② 折扣文字（ex: 95折 / 買二送一）
            let promoText = "";
            if (it.discount) {
                if (it.discount.type === "折扣") {
                    promoText = formatDiscountRate(it.discount.rate);


                } else {
                    promoText = it.discount.type;
                }
            }

            return {
                category: products.find(p => p["商品名稱"] === it.name)?.["類別"] || "",
                name: it.name,
                quantity: it.quantity,
                price: it.price,

                // 寫入試算表的：折扣後小計
                subtotal: discountedSubtotal,

                // 寫入試算表的折扣名稱
                promo: promoText
            };
        })
    };

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    });
}
// ===== 小票列印 =====
document.getElementById("posCheckout").onclick = async function () {

    // Step 1：寫入 Google Sheet
    await sendCheckoutToSheet();

    // Step 2：格式化小票內容
    function getMaxLength() {
        let maxNameLen = 0, maxQtyLen = 0, maxPriceLen = 0, maxSubtotalLen = 0;
        posCart.forEach(item => {
            maxNameLen = Math.max(maxNameLen, item.name.length);
            maxQtyLen = Math.max(maxQtyLen, item.quantity.toFixed(2).length);
            maxPriceLen = Math.max(maxPriceLen, item.price.toFixed(0).length);

            let sub = item.quantity * item.price;
            if (item.discount) {
                switch (item.discount.type) {
                    case "第二件減10": sub -= Math.floor(item.quantity / 2) * 10; break;
                    case "買二送一": sub -= Math.floor(item.quantity / 3) * item.price; break;
                    case "買一送一": sub -= Math.floor(item.quantity / 2) * item.price; break;
                    case "第二件6折": sub -= Math.floor(item.quantity / 2) * item.price * 0.4; break;
                    default: sub *= item.discount.rate || 1; break;
                }
            }
            maxSubtotalLen = Math.max(maxSubtotalLen, sub.toFixed(0).length);
        });
        return { maxNameLen, maxQtyLen, maxPriceLen, maxSubtotalLen };
    }

    function padLeft(str, len) { str = str.toString(); return ' '.repeat(Math.max(0, len - str.length)) + str; }
    function padRight(str, len) { str = str.toString(); return str + ' '.repeat(Math.max(0, len - str.length)); }

    function formatProductLine(item, maxNameLen, maxQtyLen, maxPriceLen, maxSubtotalLen) {
        let sub = item.quantity * item.price;
        let discountText = "";
        if (item.discount) {
            switch (item.discount.type) {
                case "第二件減10": sub -= Math.floor(item.quantity / 2) * 10; discountText = "第二件減10"; break;
                case "買二送一": sub -= Math.floor(item.quantity / 3) * item.price; discountText = "買二送一"; break;
                case "買一送一": sub -= Math.floor(item.quantity / 2) * item.price; discountText = "買一送一"; break;
                case "第二件6折": sub -= Math.floor(item.quantity / 2) * item.price * 0.4; discountText = "第二件6折"; break;
                default: sub *= item.discount.rate || 1; discountText = formatDiscountRate(item.discount.rate); break;
            }
        }
        let lines = [];
        let name = item.name;
        const chunk = 12;
        for (let i = 0; i < name.length; i += chunk) {
            const part = name.slice(i, i + chunk);
            if (i === 0) {
                lines.push(padRight(part, maxNameLen) + " " +
                    padLeft(item.quantity.toFixed(2), maxQtyLen) + " " +
                    padLeft(item.price.toFixed(0), maxPriceLen) + " " +
                    padLeft(sub.toFixed(0), maxSubtotalLen)
                );
            } else {
                lines.push(padRight(part, maxNameLen + maxQtyLen + maxPriceLen + maxSubtotalLen + 3));
            }
        }
        if (discountText) lines.push("  優惠: " + discountText);
        return lines.join("\n");
    }

    function formatReceipt() {
        const { maxNameLen, maxQtyLen, maxPriceLen, maxSubtotalLen } = getMaxLength();
        let content = "===== 生鮮 POS 小票 =====\n";
        content += padRight("商品", maxNameLen) + " " +
            padRight("數量", maxQtyLen) + " " +
            padRight("單價", maxPriceLen) + " " +
            padRight("小計", maxSubtotalLen) + "\n";
        content += "-".repeat(maxNameLen + maxQtyLen + maxPriceLen + maxSubtotalLen + 3) + "\n";

        posCart.forEach(item => {
            content += formatProductLine(item, maxNameLen, maxQtyLen, maxPriceLen, maxSubtotalLen) + "\n";
        });

        content += "-".repeat(maxNameLen + maxQtyLen + maxPriceLen + maxSubtotalLen + 3) + "\n";

        content += padRight("折扣總額:", maxNameLen + maxQtyLen) + padLeft(document.getElementById("discount").value || 0, maxPriceLen + maxSubtotalLen + 1) + " 元\n";
        content += padRight("稅金:", maxNameLen + maxQtyLen) +padLeft(document.getElementById("taxAmount").innerText, maxPriceLen + maxSubtotalLen + 1) + " 元\n";
        content += padRight("總額:", maxNameLen + maxQtyLen) + padLeft(document.getElementById("posTotal").innerText, maxPriceLen + maxSubtotalLen + 1) + " 元\n";
        content += padRight("付款方式:", maxNameLen + maxQtyLen) + document.getElementById("posPayment").value + "\n";

        if (document.getElementById("posPayment").value === "現金") {
            let cash = Number(document.getElementById("cashInput").value);
            let change = document.getElementById("changeOut").innerText;
            content += padRight("現金收入:", maxNameLen + maxQtyLen) + padLeft(cash.toFixed(0), maxPriceLen + maxSubtotalLen + 1) + " 元\n";
            content += padRight("找零:", maxNameLen + maxQtyLen) + padLeft(change, maxPriceLen + maxSubtotalLen + 1) + " 元\n";
        }

        content += "===== 感謝光臨 =====\n";
        return content;
    }

    // Step 3：列印
    const receiptContent = formatReceipt();
    const printWindow = window.open('', '', 'width=300,height=600');
    printWindow.document.write('<pre style="font-family:monospace;font-size:12px;line-height:1.2;">' + receiptContent + '</pre>');
    printWindow.document.write('<script>window.onload=function(){window.print();};<\/script>');
    printWindow.document.close();

    // Step 4：清空購物車
    posCart = [];
    document.getElementById("discount").value = "0";
    document.getElementById("cashInput").value = "";
    document.getElementById("changeOut").textContent = "0";
    renderCart();
};
</script>

</body>
</html>























































