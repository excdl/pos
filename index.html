<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業 POS 生鮮系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#posApp{display:flex;height:100vh;}

/* 左側分類 */
#posCategories{width:18%;background:#3498db;padding:15px;color:white;overflow-y:auto;border-radius:0 12px 12px 0;}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}

/* 中間商品 */
#posProducts{flex:1;padding:15px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;overflow-y:auto;}
.product-card{background:white;border-radius:12px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;text-align:center;transition:0.2s;cursor:pointer;}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:5px;}
.product-card h4{margin:0;font-size:0.85em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.product-card p{margin:2px 0;font-size:0.8em;color:#555;}

/* 右側訂單明細 */
#posCartContainer{width:25%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;border-left:2px solid #ddd;min-height:400px;}
#posCartContainer h3{margin-top:0;margin-bottom:10px;}
#posCart{flex:1;overflow-y:auto;margin-bottom:10px;}
.cartHeader, #posCart div{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;padding:5px;border-radius:6px;}
.cartHeader{font-weight:bold;background:#eee;}
#posCart div{background:#fff;transition:0.2s;}
#posCart div span{font-size:0.85em;cursor:pointer;}
#posCart div button{padding:2px 6px;margin-left:2px;font-size:0.8em;background:#27ae60;color:white;border:none;border-radius:4px;}

/* 結帳 */
#posCheckout{width:100%;padding:12px;font-size:1.2em;margin-top:5px;background:#27ae60;color:white;border:none;border-radius:6px;}

/* 數字鍵盤彈窗 */
#editModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#editModal .modalContent{background:#fff;padding:20px;border-radius:12px;width:320px;text-align:center;display:flex;flex-direction:column;align-items:center;}
#editModal h4{margin-bottom:10px;}
#editModal input{width:80px;text-align:center;font-size:1.3em;margin:5px;border:2px solid #ccc;border-radius:6px;}
#numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:10px;}
#numpad button{padding:15px;font-size:1.2em;background:#3498db;color:white;border:none;border-radius:6px;transition:0.2s;}
#numpad button:hover{background:#2980b9;}
.modalActions{display:flex;gap:10px;width:100%;}
.modalActions button{flex:1;padding:12px;font-size:1em;border:none;border-radius:6px;}
.modalActions .confirm{background:#27ae60;color:white;}
.modalActions .cancel{background:#e74c3c;color:white;}
</style>
</head>
<body>

<div id="posApp">
  <div id="posCategories"><h3>分類</h3></div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
    <h3>訂單明細</h3>
    <div class="cartHeader">
      <span style="flex:3">商品名稱</span>
      <span style="flex:1;text-align:center">數量</span>
      <span style="flex:1;text-align:right">單價</span>
      <span style="flex:1;text-align:right">小計</span>
      <span style="flex:0.8;text-align:center">刪除</span>
    </div>
    <div id="posCart"></div>
    <p>總額: <span id="posTotal">0</span> 元</p>
    <select id="posPayment">
      <option value="現金">現金</option>
      <option value="信用卡">信用卡</option>
      <option value="Line Pay">Line Pay</option>
    </select>
    <button id="posCheckout">結帳列印</button>
  </div>
</div>

<div id="editModal">
  <div class="modalContent">
    <h4 id="modalProductName">商品名稱</h4>
    <div>
      <label id="modalLabel">數量/單價:</label>
      <input id="modalInput" type="text" readonly value="1">
    </div>
    <div id="numpad">
      <button onclick="numpadPress('1')">1</button>
      <button onclick="numpadPress('2')">2</button>
      <button onclick="numpadPress('3')">3</button>
      <button onclick="numpadPress('4')">4</button>
      <button onclick="numpadPress('5')">5</button>
      <button onclick="numpadPress('6')">6</button>
      <button onclick="numpadPress('7')">7</button>
      <button onclick="numpadPress('8')">8</button>
      <button onclick="numpadPress('9')">9</button>
      <button onclick="numpadPress('0')">0</button>
      <button onclick="numpadBack()">←</button>
    </div>
    <div class="modalActions">
      <button class="confirm" onclick="confirmEdit()">確定</button>
      <button class="cancel" onclick="closeModal()">取消</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbym4u_bE2-YO1kXyBeSIsYWZBpdG_030NL4BVJcwEnebKGF8BSdFe9rSkjZdAaOU_-H/exec"; 
let products=[], categories=[], posCart=[];
let editIndex = null;
let editingField = "qty"; // "qty" 或 "price"

// 取商品
async function fetchProducts(){
  try{
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories = [...new Set(products.map(p=>p['類別']))].filter(Boolean);
    renderCategories();
    if(categories[0]) renderProducts(categories[0]);
  }catch(e){ console.error("抓取商品失敗:",e); }
}

// 顯示分類
function renderCategories(){
  const container = document.getElementById("posCategories");
  container.innerHTML="<h3>分類</h3>";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent=cat;
    btn.onclick=()=>{
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    container.appendChild(btn);
  });
  if(container.querySelector("button")) container.querySelector("button").classList.add("active");
}

// 顯示商品卡片
function renderProducts(category){
  const container = document.getElementById("posProducts");
  container.innerHTML="";
  products.filter(p=>p['類別']?.trim()===category?.trim()).forEach(p=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p['商品照片']}" alt="${p['商品名稱']}">
      <h4 title="${p['商品名稱']}">${p['商品名稱']}</h4>
      <p>${p['售價']} 元 / ${p['單位']}</p>
    `;
    card.onclick = () => addPOSItem(p);
    container.appendChild(card);
  });
}

// 加入訂單
function addPOSItem(product){
  const exist = posCart.find(p=>p.name===product['商品名稱']);
  if(exist) exist.quantity++;
  else posCart.push({name:product['商品名稱'],price:parseInt(product['售價']),quantity:1,unit:product['單位']});
  renderPOSCart();
}

// 渲染訂單明細
function renderPOSCart(){
  const container = document.getElementById("posCart");
  container.innerHTML="";
  let total=0;
  posCart.forEach((item,index)=>{
    const subtotal = item.price*item.quantity;
    total+=subtotal;
    const div = document.createElement("div");
    div.innerHTML=`
      <span style="flex:3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.name}</span>
      <span style="flex:1;text-align:center;">
        <button onclick="adjustQty(${index},-1)">-</button>
        <span onclick="openEditModal(${index},'qty')">${item.quantity}${item.unit}</span>
        <button onclick="adjustQty(${index},1)">+</button>
      </span>
      <span style="flex:1;text-align:right;" onclick="openEditModal(${index},'price')">${item.price}</span>
      <span style="flex:1;text-align:right;">${subtotal}</span>
      <span style="flex:0.8;text-align:center;"><button onclick="removePOSItem(${index})">刪除</button></span>
    `;
    container.appendChild(div);
  });
  document.getElementById("posTotal").textContent=total;
}

function adjustQty(index,delta){
  posCart[index].quantity=Math.max(1,posCart[index].quantity+delta);
  renderPOSCart();
}

function removePOSItem(index){
  posCart.splice(index,1);
  renderPOSCart();
}

// 數字鍵盤彈窗
function openEditModal(index, field){
  editIndex = index;
  editingField = field; // qty 或 price
  const item = posCart[index];
  document.getElementById("modalProductName").textContent = item.name;
  const input = document.getElementById("modalInput");
  input.value = editingField==="qty"?item.quantity:item.price;
  document.getElementById("modalLabel").textContent = editingField==="qty"?"數量":"單價";
  document.getElementById("editModal").style.display = "flex";
}

function closeModal(){ 
  document.getElementById("editModal").style.display = "none"; 
  editIndex=null; 
  renderPOSCart(); 
}

function numpadPress(num){
  const input = document.getElementById("modalInput");
  input.value = (input.value==="0"?num:input.value + num);
}

function numpadBack(){
  const input = document.getElementById("modalInput");
  input.value = input.value.slice(0,-1) || "0";
}

function confirmEdit(){
  const inputValue = parseInt(document.getElementById("modalInput").value);
  if(editingField==="qty"){
    posCart[editIndex].quantity = isNaN(inputValue) || inputValue<1 ? 1 : inputValue;
  } else {
    posCart[editIndex].price = isNaN(inputValue) || inputValue<0 ? 0 : inputValue;
  }
  closeModal();
}

// 結帳
document.getElementById("posCheckout").onclick = async function(){
  if(posCart.length===0){ alert("沒有商品"); return; }
  const totalAmount = posCart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const paymentMethod = document.getElementById("posPayment").value;
  const data = {userId:"POS_User",totalAmount,paymentMethod,items:posCart};

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    const result = await res.json();
    if(result.status==="success"){
      alert("訂單完成，單號：" + result.orderId);
      posCart=[]; renderPOSCart();
    } else alert("列印失敗：" + result.message);
  }catch(e){ alert("結帳失敗:"+e); }
}

// 初始化
fetchProducts();
</script>

</body>
</html>





