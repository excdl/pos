<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業觸控 POS 生鮮蔬果系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;}
#posApp{display:flex;height:100vh;}

/* 左側分類 */
#posCategories{width:15%;background:#eee;padding:10px;overflow-y:auto;}
#posCategories button{width:100%;margin:5px 0;padding:15px;font-size:1.1em;border:none;border-radius:6px;transition:0.2s;touch-action: manipulation;}
#posCategories button.active{background:#7ed6df;color:white;}

/* 中間商品 */
#posProducts{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;overflow-y:auto;}
.product-card{background:white;border-radius:8px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition:0.2s;text-align:center;cursor:pointer;touch-action: manipulation;}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:6px;margin-bottom:5px;transition:0.2s;}
.product-card:hover img{transform:scale(1.05);}

/* 右側訂單明細 */
#posCartContainer{width:28%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow:hidden;}
#posCart{flex:1;overflow-y:auto;margin-bottom:10px;}
#posCart div{display:flex;justify-content:space-between;margin-bottom:5px;background:#fff;padding:8px;border-radius:6px;align-items:center;touch-action: manipulation;}
#posCart div span{cursor:pointer;flex:1;}
#posCart div button{background:#ff6b6b;color:white;border:none;border-radius:4px;padding:5px 10px;font-size:0.9em;}
#cartFooter{background:#eee;padding:10px;border-radius:6px;flex-shrink:0;}
#posTotal{font-weight:bold;font-size:1.2em;}
#posCheckout{width:100%;padding:12px;font-size:1.2em;margin-top:10px;background:#27ae60;color:white;border:none;border-radius:6px;}

/* 編輯商品 Modal */
#editModal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:white;padding:25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:999;}
#editModal input{width:100px;margin-right:10px;padding:8px;font-size:1em;}
#editModal button{margin-top:10px;padding:8px 15px;font-size:1em;cursor:pointer;}
#modalOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:998;}
</style>
</head>
<body>

<div id="posApp">
  <div id="posCategories"><h3>分類</h3></div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
    <h3>訂單明細</h3>
    <div id="posCart"></div>
    <div id="cartFooter">
      <p>總額: <span id="posTotal">0</span> 元</p>
      <select id="posPayment" style="width:100%;padding:8px;font-size:1em;">
        <option value="現金">現金</option>
        <option value="信用卡">信用卡</option>
        <option value="Line Pay">Line Pay</option>
      </select>
      <button id="posCheckout">結帳列印</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modalOverlay"></div>
<div id="editModal">
  <h4 id="editItemName"></h4>
  <label>數量: <input type="number" id="editQuantity" min="1"></label><br><br>
  <label>單價: <input type="number" id="editPrice" min="0"></label><br><br>
  <button id="saveEdit">儲存</button>
  <button id="cancelEdit">取消</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwirPClxxyzxPPm5w4y6IY8eue5JBGoBGV1MW6Hb1OyGjjfyxK2HG-ulHga5NV2zvUi/exec"; 
let products=[], categories=[], posCart=[], currentEditIndex=null;

// ===== 抓取商品 =====
async function fetchProducts(){
  try{
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories = [...new Set(products.map(p=>p['類別']))].filter(Boolean);
    renderCategories();
    if(categories[0]) renderProducts(categories[0]);
  }catch(e){ console.error("抓取商品失敗:",e); }
}

// ===== 顯示分類 =====
function renderCategories(){
  const container = document.getElementById("posCategories");
  container.innerHTML="<h3>分類</h3>";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent=cat;
    btn.onclick=()=>{
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    container.appendChild(btn);
  });
  if(container.querySelector("button")) container.querySelector("button").classList.add("active");
}

// ===== 顯示商品 =====
function renderProducts(category){
  const container = document.getElementById("posProducts");
  container.innerHTML="";
  products.filter(p=>p['類別']?.trim()===category?.trim()).forEach(p=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML=`<img src="${p['商品照片']}" alt="${p['商品名稱']}">
                    <h4>${p['商品名稱']}</h4>
                    <p>${p['售價']} 元</p>`;
    card.onclick=()=>addPOSItem(p);
    container.appendChild(card);
  });
}

// ===== 加入訂單 =====
function addPOSItem(product){
  const exist = posCart.find(p=>p.name===product['商品名稱']);
  if(exist) exist.quantity++;
  else posCart.push({name:product['商品名稱'],price:parseInt(product['售價']),quantity:1});
  renderPOSCart();
}

// ===== 刪除訂單商品 =====
function removePOSItem(index){
  posCart.splice(index,1);
  renderPOSCart();
}

// ===== 渲染訂單明細 =====
function renderPOSCart(){
  const container = document.getElementById("posCart");
  container.innerHTML="";
  let total=0;
  posCart.forEach((item,index)=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;

    const div = document.createElement("div");
    div.innerHTML=`<span>${item.name} x ${item.quantity}</span>
                   <span>${subtotal} 元</span>
                   <button onclick="removePOSItem(${index})">刪除</button>`;
    div.querySelector("span:first-child").onclick=()=>openEditModal(index);
    container.appendChild(div);
  });
  document.getElementById("posTotal").textContent=total;
}

// ===== 編輯 Modal =====
function openEditModal(index){
  currentEditIndex = index;
  const item = posCart[index];
  document.getElementById("editItemName").textContent = item.name;
  document.getElementById("editQuantity").value = item.quantity;
  document.getElementById("editPrice").value = item.price;
  document.getElementById("modalOverlay").style.display="block";
  document.getElementById("editModal").style.display="block";
}
document.getElementById("saveEdit").onclick=function(){
  if(currentEditIndex!==null){
    posCart[currentEditIndex].quantity=parseInt(document.getElementById("editQuantity").value);
    posCart[currentEditIndex].price=parseInt(document.getElementById("editPrice").value);
    renderPOSCart();
    closeEditModal();
  }
};
document.getElementById("cancelEdit").onclick=closeEditModal;
document.getElementById("modalOverlay").onclick=closeEditModal;
function closeEditModal(){
  document.getElementById("modalOverlay").style.display="none";
  document.getElementById("editModal").style.display="none";
  currentEditIndex=null;
}

// ===== 結帳 =====
document.getElementById("posCheckout").onclick=async function(){
  if(posCart.length===0){ alert("沒有商品"); return; }
  const totalAmount = posCart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const paymentMethod = document.getElementById("posPayment").value;
  const data={userName:"店員",totalAmount,paymentMethod,items:posCart};

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    const result = await res.json();
    if(result.status==="success"){
      alert("訂單完成，單號：" + result.orderId);
      posCart=[]; renderPOSCart();
    } else alert("結帳失敗：" + result.message);
  }catch(e){ alert("結帳失敗:"+e); }
}

// ===== 初始化 =====
fetchProducts();
</script>
</body>
</html>



