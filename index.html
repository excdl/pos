<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台灣生鮮 POS 系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#loginPage,#posApp{height:100vh;width:100%;display:flex;justify-content:center;align-items:center;}
#loginPage{flex-direction:column;background:#3498db;color:white;}
#loginPage input{margin:5px 0;padding:10px;border-radius:6px;border:none;font-size:1em;}
#loginPage button{padding:10px 20px;border:none;border-radius:6px;background:#f1c40f;color:#2c3e50;font-weight:bold;font-size:1em;cursor:pointer;}
#posApp{display:none;flex-direction:row;}
#posCategories{width:18%;background:#3498db;padding:15px;color:white;overflow-y:auto;border-radius:0 12px 12px 0;}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#posProducts{flex:1;padding:15px 0 15px 5%;display:flex;flex-wrap:wrap;gap:15px;justify-content:flex-start;align-content:flex-start;overflow-y:auto;}
.product-card{background:white;border-radius:12px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;justify-content:flex-start;text-align:center;transition:0.3s;cursor:pointer;width:120px;height:200px;flex-shrink:0;}
.product-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,0.15);}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:5px;}
.product-card h4{margin:0;font-size:0.6em;line-height:1.2em;white-space:normal;word-wrap:break-word;max-height:2.4em;overflow:hidden;text-overflow:ellipsis;}
.product-card p{margin:2px 0 0 0;font-size:0.8em;color:#555;}
#posCartContainer{width:27%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;border-left:2px solid #ddd;}
.cartHeader{font-weight:bold;background:#eee;font-size:80%;display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr;gap:5px;padding:5px;border-radius:6px;text-align:center;}
#posCart div.cartRow{display:grid;grid-template-columns:2.5fr 1fr 1fr 1fr 1fr;gap:5px;background:white;padding:5px;margin-bottom:5px;border-radius:6px;align-items:center;text-align:center;font-size:0.75em;}
#posCart div.cartRow span.name{text-align:left;cursor:pointer;}
#discountContainer{display:flex;gap:5px;margin:5px 0;}
#discountContainer input{flex:1;padding:6px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:0.9em;cursor:pointer;}
#taxContainer{display:flex;flex-wrap:wrap;gap:5px;margin:5px 0;}
#taxContainer button{flex:1 1 30%;padding:6px;border:none;border-radius:6px;background:#bdc3c7;cursor:pointer;}
#taxContainer button.active{background:#f1c40f;color:#333;font-weight:bold;}
#cashPanel{display:block;margin-top:5px;}
#cashPanel input{width:100%;padding:8px;margin-top:5px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:1em;cursor:pointer;}
#posCheckout,#posShift{margin-top:8px;padding:12px;font-size:1.2em;background:#27ae60;color:white;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>

<!-- 登入頁面 -->
<div id="loginPage">
  <h2>分店 POS 登入</h2>
  <p id="storeName">分店: 讀取中...</p>
  <input type="text" id="userIdInput" placeholder="登入人員ID">
  <input type="password" id="passwordInput" placeholder="密碼">
  <button onclick="login()">登入</button>
</div>

<!-- POS 主頁 -->
<div id="posApp">
  <div id="posCategories">
    <input type="text" id="searchBox" placeholder="搜尋商品">
    <h3>分類</h3>
  </div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
    <h3 style="font-size:85%;">訂單明細</h3>
    <div class="cartHeader">
      <span>商品</span>
      <span>數量</span>
      <span>單價</span>
      <span>小計</span>
      <span>刪除</span>
    </div>
    <div id="posCart"></div>
    <div id="discountContainer">
      <input type="text" id="discount" placeholder="折扣金額" readonly>
    </div>
    <div id="taxContainer">
      <button id="taxIncluded" class="active" onclick="setTax('應稅')">應稅</button>
      <button id="taxExempt" onclick="setTax('免稅')">免稅</button>
      <button id="taxAmountBtn" disabled>應稅金額: <span id="taxAmount">0</span></button>
    </div>
    <p>總額：<span id="posTotal">0</span> 元</p>
    <select id="posPayment">
      <option value="現金" selected>現金</option>
      <option value="信用卡">信用卡</option>
      <option value="Line Pay">Line Pay</option>
    </select>
    <div id="cashPanel">
      <input id="cashInput" placeholder="收現金額" type="text" readonly>
      <p>找零：<span id="changeOut">0</span> 元</p>
    </div>
    <button id="posCheckout">結帳列印</button>
    <button id="posShift" onclick="shiftReport()">當日交班</button>
  </div>
</div>


<script>
// ===== 變數初始化 =====
const API_URL = "https://script.google.com/macros/s/AKfycbzz3Bsm8ntNDmFkHbNFlDzQJoIWChz2j8O5LVhv4sAx1iaXM1jBhJhZT5xEN4I9DF-6/exec";
let products = [], categories = [], posCart = [];
let currentTax = "應稅", editIndex = null, editingField = null, modalType = null;
let userId = "", userName = "", storeName = "";

// ===== 抓取分店 IP 與顯示 =====
async function fetchStoreByIP(){
  try {
    const ipRes = await fetch("https://api.ipify.org?format=json");
    const ipData = await ipRes.json();
    const ip = ipData.ip;
    // 假設後台 API 可以透過 IP 查分店名稱
    const storeRes = await fetch(API_URL + "?action=getStore&ip=" + ip);
    const storeData = await storeRes.json();
    storeName = storeData.name || "未識別分店";
    document.getElementById("storeName").innerText = "分店: " + storeName;
  } catch(e){
    console.error(e);
    document.getElementById("storeName").innerText = "分店: 讀取失敗";
  }
}
fetchStoreByIP();

// ===== 登入功能 =====
function login(){
  const id = document.getElementById("userIdInput").value.trim();
  const pwd = document.getElementById("passwordInput").value.trim();
  if(!id || !pwd){ alert("請輸入帳號與密碼"); return; }
  // 簡單模擬驗證，可換成 API 驗證
  userId = id; userName = id;
  document.getElementById("loginPage").style.display="none";
  document.getElementById("posApp").style.display="flex";
  fetchProducts();
}

// ===== 取得商品 =====
async function fetchProducts(){
  try {
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories = [...new Set(products.map(x=>x["類別"]))];
    renderCategories();
    if(categories.length>0) renderProducts(categories[0]);
  } catch(e){
    console.error("商品取得失敗", e);
  }
}

// ===== 渲染分類 =====
function renderCategories(){
  const box = document.getElementById("posCategories");
  box.querySelectorAll("button").forEach(b=>b.remove());
  categories.forEach(cat=>{
    const btn=document.createElement("button");
    btn.textContent=cat;
    btn.onclick = ()=> {
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    box.appendChild(btn);
  });
  if(box.querySelector("button")) box.querySelector("button").classList.add("active");
}

// ===== 搜尋商品 =====
document.getElementById("searchBox").oninput = function(){
  renderProducts(null, this.value.trim().toLowerCase());
};

// ===== 渲染商品列表 =====
function renderProducts(category=null, search=""){
  const box = document.getElementById("posProducts");
  box.innerHTML = "";
  products.filter(p=>{
    if(category && p["類別"]!==category) return false;
    if(search && !p["商品名稱"].toLowerCase().includes(search)) return false;
    return true;
  }).forEach(p=>{
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `<img src="${p["商品照片"]}"><h4>${p["商品名稱"]}</h4><p>${p["售價"]} 元 / ${p["單位"]}</p>`;
    card.onclick = ()=>addPOSItem(p);
    box.appendChild(card);
  });
}

// ===== 加入購物車 =====
function addPOSItem(p){
  let qtyAdd = 1;
  let pricePerUnit = Number(p["售價"]);
  let unit = p["單位"];
  if(p["單位"]==="半斤"){qtyAdd=0.5; pricePerUnit*=2; unit="斤";}
  let exist = posCart.find(x=>x.name===p["商品名稱"]);
  if(exist){exist.quantity+=qtyAdd;}
  else{posCart.push({name:p["商品名稱"],quantity:qtyAdd,price:pricePerUnit,unit:unit,category:p["類別"],discount:null});}
  renderCart();
}

// ===== 渲染購物車 =====
function renderCart(){
  const box = document.getElementById("posCart"); 
  box.innerHTML="";
  let total=0;
  posCart.forEach((item,i)=>{
    let sub = item.quantity*item.price;
    let discountText = "";
    if(item.discount){
      switch(item.discount.type){
        case "第二件減10": sub -= Math.floor(item.quantity/2)*10; discountText="第二件減10元"; break;
        case "買二送一": sub -= Math.floor(item.quantity/3)*item.price; discountText="買二送一"; break;
        case "買一送一": sub -= Math.floor(item.quantity/2)*item.price; discountText="買一送一"; break;
        case "第二件6折": sub -= Math.floor(item.quantity/2)*item.price*0.4; discountText="第二件6折"; break;
        default: sub *= item.discount.rate||1; discountText = `折扣 ${((1-item.discount.rate)*100).toFixed(0)}%`; break;
      }
    }
    total += sub;
    const row = document.createElement("div");
    row.className="cartRow";
    row.innerHTML = `<span class="name" onclick="openPromoModal(posCart[${i}])">${item.name}${discountText?`<br><small>${discountText}</small>`:""}</span>
    <span class="qty" onclick="openEditModal(${i},'quantity')">${item.quantity.toFixed(2)} ${item.unit}</span>
    <span class="price" onclick="openEditModal(${i},'price')">${item.price}</span>
    <span class="subtotal">${sub.toFixed(0)}</span>
    <span class="remove"><button onclick="removeItem(${i})">刪</button></span>`;
    box.appendChild(row);
  });
  let discountValue=Number(document.getElementById("discount").value)||0;
  let taxBase=total-discountValue;
  let tax=currentTax==="應稅"?taxBase*0.05:0;
  document.getElementById("taxAmount").innerText=tax.toFixed(0);
  document.getElementById("posTotal").innerText=(taxBase+tax).toFixed(0);
  updateChange();
}

// ===== 刪除商品 =====
function removeItem(i){ posCart.splice(i,1); renderCart(); }

// ===== 編輯數量/折扣/收現 =====
document.getElementById("discount").onclick=()=>openEditModal(null,'discount');
document.getElementById("cashInput").onclick=()=>openEditModal(null,'cash');

<script>
// ===== 編輯數量/折扣 Modal =====
function openEditModal(index,field){
  editIndex=index; editingField=field; modalType=field;
  document.getElementById("promoButtons").style.display='none';
  document.getElementById("numpad").style.display='grid';
  let value=(field==='discount'?document.getElementById("discount").value
    :field==='cash'?document.getElementById("cashInput").value
    :posCart[index][field]);
  document.getElementById("modalInput").value=value;
  document.getElementById("modalProductName").innerText = field==='cash'?'收現金': field==='discount'?'折扣':'輸入';
  document.getElementById("editModal").style.display="flex";
}

// ===== 優惠方案 Modal =====
function openPromoModal(item){
  modalType='promo'; editIndex=null;
  document.getElementById("numpad").style.display='none';
  const promoDiv=document.getElementById("promoButtons");
  promoDiv.style.display='grid';
  promoDiv.innerHTML='';
  const promoList=[
    {name:'95折',rate:0.95},{name:'9折',rate:0.9},{name:'85折',rate:0.85},{name:'8折',rate:0.8},
    {name:'7折',rate:0.7},{name:'6折',rate:0.6},{name:'買一送一',type:'買一送一'},{name:'買二送一',type:'買二送一'},
    {name:'第二件減10',type:'第二件減10'},{name:'第二件6折',type:'第二件6折'}
  ];
  promoList.forEach(p=>{
    const btn=document.createElement('button');
    btn.innerText=p.name;
    btn.onclick=()=>{
      let idx=posCart.findIndex(x=>x.name===item.name);
      if(idx===-1) addPOSItem(item);
      idx=posCart.findIndex(x=>x.name===item.name);
      if(p.type) posCart[idx].discount={type:p.type};
      else posCart[idx].discount={rate:p.rate,type:'折扣'};
      closeModal(); renderCart();
    };
    promoDiv.appendChild(btn);
  });
  document.getElementById("modalProductName").innerText=item.name;
  document.getElementById("editModal").style.display='flex';
  document.getElementById("editModal").classList.add("promoMode");
}

// ===== 數字鍵盤 =====
function np(v){
  let input=document.getElementById("modalInput");
  input.value=(input.value==='0'&&v!=='.')?v:input.value+v;
}
function backspace(){
  let input=document.getElementById("modalInput");
  input.value=input.value.slice(0,-1);
  if(input.value==='') input.value='0';
}

// ===== 確定編輯 =====
function confirmEdit(){
  let val=document.getElementById("modalInput").value;
  if(editIndex!==null && editingField==='quantity' && posCart[editIndex].unit==='斤'){
    const parts=val.split('.');
    let j=Number(parts[0])||0;
    let l=Number(parts[1])||0;
    let q=Number(parts[2])||0;
    let totalQty=j + l/16 + q/160;
    posCart[editIndex].quantity=totalQty;
  } else {
    let v=Number(val);
    if(modalType==='discount') document.getElementById("discount").value=v;
    else if(modalType==='cash') document.getElementById("cashInput").value=v;
    else if(editIndex!==null) posCart[editIndex][editingField]=v;
  }
  closeModal(); renderCart();
}

function closeModal(){
  document.getElementById("editModal").style.display='none'; 
  editIndex=null; editingField=null; modalType=null;
  document.getElementById("editModal").classList.remove("promoMode");
}

// ===== 稅金切換 =====
function setTax(t){ 
  currentTax=t; 
  document.getElementById("taxIncluded").classList.toggle('active',t==="應稅"); 
  document.getElementById("taxExempt").classList.toggle('active',t==="免稅"); 
  renderCart(); 
}

// ===== 現金找零更新 =====
function updateChange(){ 
  let cash=Number(document.getElementById("cashInput").value)||0;
  let total=Number(document.getElementById("posTotal").innerText)||0;
  document.getElementById("changeOut").innerText=Math.max(0,cash-total).toFixed(0);
}

// ===== 結帳功能 =====
document.getElementById("posCheckout").onclick=function(){
  const total=parseFloat(document.getElementById("posTotal").textContent)||0;
  let cash=parseFloat(document.getElementById("cashInput").value)||0;
  let paymentType=document.getElementById("posPayment").value;
  let change=(paymentType==="現金")?(cash-total).toFixed(2):"0.00";

  const orderNo = generateOrderNo();
  const dateObj = new Date();
  const dateStr = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')}`;
  const timeStr = `${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}:${dateObj.getSeconds().toString().padStart(2,'0')}`;

  // === 結帳明細寫入 Google Sheet ===
  const checkoutData = {
    orderNo: orderNo,
    orderDate: dateStr,
    orderTime: timeStr,
    userId: userId,
    userName: userName,
    totalAmount: total,
    payment: paymentType,
    cashReceived: cash,
    change: change
  };

  const salesDetails = posCart.map(item=>{
    let sub = item.quantity*item.price;
    let discountText = "";
    if(item.discount){
      switch(item.discount.type){
        case "第二件減10": sub -= Math.floor(item.quantity/2)*10; discountText="第二件減10元"; break;
        case "買二送一": sub -= Math.floor(item.quantity/3)*item.price; discountText="買二送一"; break;
        case "買一送一": sub -= Math.floor(item.quantity/2)*item.price; discountText="買一送一"; break;
        case "第二件6折": sub -= Math.floor(item.quantity/2)*item.price*0.4; discountText="第二件6折"; break;
        default: sub *= item.discount.rate||1; discountText = `折扣 ${((1-item.discount.rate)*100).toFixed(0)}%`; break;
      }
    }
    return {
      id: generateRandomId(8),
      orderNo: orderNo,
      orderDate: dateStr,
      userId: userId,
      userName: userName,
      category: item.category,
      name: item.name,
      quantity: item.quantity,
      price: item.price,
      subtotal: sub,
      discountDetail: discountText
    };
  });

  // 發送資料到 Google Sheet
  fetch(API_URL + "?action=checkout",{
    method:"POST",
    body: JSON.stringify({checkout:checkoutData, sales:salesDetails}),
    headers: {"Content-Type":"application/json"}
  }).then(res=>res.json()).then(r=>{
    console.log("結帳寫入成功", r);
    alert("結帳成功!");
    posCart=[]; 
    renderCart(); 
    document.getElementById("discount").value=""; 
    document.getElementById("cashInput").value=""; 
    document.getElementById("changeOut").textContent="0";
  }).catch(e=>{console.error(e); alert("結帳失敗!");});
}

// ===== 生成單號 =====
function generateOrderNo(){
  const dateObj=new Date();
  const rocYear=dateObj.getFullYear()-1911;
  const month=(dateObj.getMonth()+1).toString().padStart(2,'0');
  const day=dateObj.getDate().toString().padStart(2,'0');
  const timeStr=dateObj.getHours().toString().padStart(2,'0')+
                dateObj.getMinutes().toString().padStart(2,'0')+
                dateObj.getSeconds().toString().padStart(2,'0');
  const rand = Math.floor(Math.random()*900+100);
  return `${rocYear}${month}${day}${timeStr}${rand}`;
}

// ===== 生成隨機ID =====
function generateRandomId(length){
  let chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id='';
  for(let i=0;i<length;i++){
    id+=chars.charAt(Math.floor(Math.random()*chars.length));
  }
  return id;
}

// ===== 當日結帳 / 交班功能 =====
function dailyReport(){
  const dateObj = new Date();
  const dateStr = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')}`;
  fetch(API_URL + "?action=dailyReport&date="+dateStr+"&store="+storeName)
  .then(res=>res.json())
  .then(r=>alert("當日結帳總額: " + r.totalAmount))
  .catch(e=>alert("取得當日結帳失敗"));
}
</script>
<!-- 結帳 Modal -->
<div id="checkoutModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:10000;">
  <div style="background:white;padding:20px;border-radius:12px;width:300px;text-align:left;" id="checkoutContent">
    <!-- 結帳明細會動態生成 -->
  </div>
</div>
</body>
</html>










