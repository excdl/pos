<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業 POS 生鮮系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#posApp{display:flex;height:100vh;}

/* 左側分類 + 搜尋 */
#posCategories{
  width:18%;
  background:#3498db;
  padding:15px;
  color:white;
  overflow-y:auto;
  border-radius:0 12px 12px 0;
}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#searchBox{margin-bottom:10px;padding:8px;width:100%;border-radius:6px;border:none;font-size:0.9em;}

/* 中間商品 */
#posProducts{flex:1;padding:15px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;overflow-y:auto;}
.product-card{background:white;border-radius:12px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;text-align:center;transition:0.2s;cursor:pointer;}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:5px;}
.product-card h4{margin:0;font-size:0.85em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.product-card p{margin:2px 0;font-size:0.8em;color:#555;}


/* 右側購物車 */
#posCartContainer{
  width:27%;
  background:#f7f7f7;
  padding:10px;
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  border-left:2px solid #ddd;
}
.cartHeader{
  font-weight:bold;
  background:#eee;
  font-size:80%;
  display:flex;
  justify-content:space-between;
  padding:5px;
  border-radius:6px;
}
#posCart div{display:flex;justify-content:space-between;align-items:center;background:white;padding:5px;margin-bottom:5px;border-radius:6px;font-size:0.75em;}
#posCart span.name{flex:2.5;}
#posCart span.qty,#posCart span.price,#posCart span.subtotal,#posCart span.remove{flex:1;text-align:center;}
#posCart span.subtotal{text-align:right;}
#posCart span.price{text-align:right;}
#posCart span.remove button{padding:3px 6px;font-size:0.7em;background:#e74c3c;color:white;border:none;border-radius:4px;}

/* 折扣區 */
#discountContainer{
  display:flex; gap:5px; margin:5px 0; align-items:center;
}
#discountContainer input{
  flex:1;
  padding:8px;
  border:2px solid #ccc;
  border-radius:6px;
  text-align:right;
  font-size:1em;
}
#discountButtons{
  flex:1;
  display:flex;
  gap:3px;
  flex-wrap:wrap;
}
#discountButtons button{
  flex:1;
  white-space:nowrap;
  padding:6px;
  font-size:0.9em;
  border:none;
  border-radius:6px;
  background:#3498db;
  color:white;
  cursor:pointer;
  text-overflow:ellipsis;
  overflow:hidden;
}

/* 稅金區（同列排列） */
#taxContainer{display:flex;gap:5px;margin:5px 0;align-items:center;}
#taxContainer span{font-size:0.85em;}
#taxContainer button{
  flex:1;
  padding:4px 6px;
  font-size:0.8em;
  border:none;
  border-radius:6px;
  background:#bdc3c7;
  cursor:pointer;
}
#taxContainer button.active{background:#f1c40f;color:#333;font-weight:bold;}

/* 現金付款 */
#cashPanel{margin-top:5px; display:flex; flex-direction:column;}
#cashPanel input{
  width:100%; padding:8px; margin-top:5px; border:2px solid #ccc; border-radius:6px; text-align:right; font-size:1em;
}

/* 結帳按鈕 */
#posCheckout{margin-top:8px;padding:12px;font-size:1.2em;background:#27ae60;color:white;border:none;border-radius:6px;}

/* 數字鍵盤彈窗 */
#editModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#editModal .modalContent{background:white;padding:20px;border-radius:12px;width:320px;text-align:center;}
#editModal input{width:120px;font-size:1.4em;text-align:center;border:2px solid #ccc;border-radius:6px;margin:8px 0;}
#numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}
#numpad button{padding:15px;background:#3498db;color:white;font-size:1.2em;border:none;border-radius:6px;}
.modalActions{display:flex;gap:5px;margin-top:10px;}
.modalActions button{flex:1;padding:10px;border:none;border-radius:6px;}
.confirm{background:#27ae60;color:white;}
.cancel{background:#e74c3c;color:white;}
.convert{background:#f39c12;color:white;}
</style>
</head>
<body>
<div id="posApp">
  <!-- 左側分類 + 搜尋 -->
  <div id="posCategories">
    <input type="text" id="searchBox" placeholder="搜尋商品" onclick="openSearchKeyboard()">
    <h3>分類</h3>
  </div>

  <!-- 中間商品 -->
  <div id="posProducts"></div>

  <!-- 右側購物車 -->
  <div id="posCartContainer">
    <h3 style="font-size:85%;">訂單明細</h3>
    <div class="cartHeader">
      <span style="flex:2.5">商品</span>
      <span style="flex:1">數量</span>
      <span style="flex:1">單價</span>
      <span style="flex:1">小計</span>
      <span style="flex:1">刪除</span>
    </div>

    <div id="posCart"></div>

    <!-- 折扣區 -->
    <div id="discountContainer">
      <input type="text" id="discount" placeholder="折扣金額" readonly onclick="openDiscountModal()">
      <div id="discountButtons">
        <button onclick="setDiscount(0.95)">95折</button>
        <button onclick="setDiscount(0.9)">9折</button>
        <button onclick="setDiscount(0.85)">85折</button>
        <button onclick="setDiscount(0.8)">8折</button>
        <button onclick="clearDiscount()">清除</button>
      </div>
    </div>

    <!-- 稅金區同列 -->
    <div id="taxContainer">
      <span>稅金：</span>
      <button id="taxIncluded" class="active" onclick="setTax('內含稅')">內含稅</button>
      <button id="taxExtra" onclick="setTax('外加稅')">外加稅</button>
      <button id="taxExempt" onclick="setTax('免稅')">免稅</button>
      <span id="taxAmount">0</span> 元
    </div>

    <p>總額：<span id="posTotal">0</span> 元</p>

    <!-- 付款方式 -->
    <select id="posPayment">
      <option value="現金" selected>現金</option>
      <option value="信用卡">信用卡</option>
      <option value="Line Pay">Line Pay</option>
    </select>

    <!-- 現金收款/找零 -->
    <div id="cashPanel">
      <input id="cashInput" placeholder="收現金額" type="number" readonly onclick="openCashModal()">
      <p>找零：<span id="changeOut">0</span> 元</p>
    </div>

    <button id="posCheckout">結帳列印</button>
  </div>
</div>

<!-- 數字鍵盤彈窗 -->
<div id="editModal">
  <div class="modalContent">
    <h4 id="modalProductName">輸入</h4>
    <input id="modalInput" readonly>
    <div id="numpad">
      <button onclick="np('7')">7</button>
      <button onclick="np('8')">8</button>
      <button onclick="np('9')">9</button>
      <button onclick="np('4')">4</button>
      <button onclick="np('5')">5</button>
      <button onclick="np('6')">6</button>
      <button onclick="np('1')">1</button>
      <button onclick="np('2')">2</button>
      <button onclick="np('3')">3</button>
      <button onclick="np('0')">0</button>
      <button onclick="np('.')">.</button>
      <button onclick="backspace()">←</button>
    </div>
    <div class="modalActions">
      <button class="cancel" onclick="closeModal()">取消</button>
      <button class="convert" onclick="convertToJin()">換算斤</button>
      <button class="confirm" onclick="confirmEdit()">確定</button>
    </div>
  </div>
</div>

<script>
//====================================================
// 全域變數
//====================================================
const API_URL = "https://script.google.com/macros/s/AKfycbz9c02iIuKd5ZDWauXlU4RJvujVQeH9-ErIYyKTdOdedqASQThsSCMa973uA5fP6v58/exec";
let products = [];
let categories = [];
let posCart = [];
let currentTax = "內含稅";
let editIndex = null;
let editingField = null;
let editingDiscount = false;

//====================================================
// 載入商品資料
//====================================================
async function fetchProducts(){
  const res = await fetch(API_URL + "?action=products");
  products = await res.json();
  categories = [...new Set(products.map(x=>x["類別"]))];
  renderCategories();
  renderProducts();
}
fetchProducts();

//====================================================
// 左側分類
//====================================================
function renderCategories(){
  const box = document.getElementById("posCategories");
  box.innerHTML = "<h3>分類</h3>";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = ()=>{
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    box.appendChild(btn);
  });
  if(box.querySelector("button")) box.querySelector("button").classList.add("active");
}

//====================================================
// 商品卡片
//====================================================
function renderProducts(filterCat=null, search=""){
  const box = document.getElementById("posProducts");
  box.innerHTML = "";
  let filtered = products;
  if(filterCat) filtered = filtered.filter(p=>p["類別"]===filterCat);
  if(search) filtered = filtered.filter(p=>p["商品名稱"].includes(search));
  filtered.forEach(p=>{
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `<img src="${p["商品照片"]}">
                      <h4>${p["商品名稱"]}</h4>
                      <p>${p["售價"]} 元 / ${p["單位"]}</p>`;
    card.onclick = ()=> addPOSItem(p);
    box.appendChild(card);
  });
}

//====================================================
// 搜尋鍵盤
//====================================================
function openSearchKeyboard(){
  editingDiscount = false;
  editIndex = null;
  editingField = "search";
  document.getElementById("modalProductName").innerText = "搜索商品";
  document.getElementById("modalInput").value = "";
  document.getElementById("editModal").style.display = "flex";
}
function confirmSearch(){
  const search = document.getElementById("modalInput").value;
  renderProducts(null, search);
  closeModal();
}

//====================================================
// 加入商品（半斤自動換算）
//====================================================
function addPOSItem(p){
  let qtyAdd = 1;
  let unit = p["單位"];
  let price = Number(p["售價"]);
  if(unit==="半斤"){ qtyAdd = 0.5; price = price*2; unit="斤"; }
  let exist = posCart.find(x=>x.name===p["商品名稱"]);
  if(exist){
    exist.quantity += qtyAdd;
  }else{
    posCart.push({ name: p["商品名稱"], quantity: qtyAdd, price: price, unit: unit });
  }
  renderCart();
}

//====================================================
// 渲染購物車
//====================================================
function renderCart(){
  const box = document.getElementById("posCart");
  box.innerHTML = "";
  let total = 0;
  posCart.forEach((item,i)=>{
    let sub = item.quantity * item.price;
    total += sub;
    const row = document.createElement("div");
    row.innerHTML = `<span class="name">${item.name}</span>
                     <span class="qty" onclick="openEdit(${i},'qty')">${item.quantity.toFixed(2)} ${item.unit}</span>
                     <span class="price" onclick="openEdit(${i},'price')">${item.price}</span>
                     <span class="subtotal">${sub.toFixed(0)}</span>
                     <span class="remove"><button onclick="removeItem(${i})">刪</button></span>`;
    box.appendChild(row);
  });
  const disc = Number(document.getElementById("discount").value) || 0;
  let finalTotal = total - disc;
  document.getElementById("posTotal").innerText = finalTotal.toFixed(0);

  // 稅金計算
  let tax = 0;
  if(currentTax==="內含稅") tax = finalTotal*0.05;
  else if(currentTax==="外加稅") tax = finalTotal*0.05;
  document.getElementById("taxAmount").innerText = tax.toFixed(0);

  // 找零更新
  updateChange();
}

//====================================================
// 刪除單品
//====================================================
function removeItem(i){ posCart.splice(i,1); renderCart(); }

//====================================================
// 彈窗 — 編輯數量/單價
//====================================================
function openEdit(i,field){
  editIndex = i;
  editingField = field;
  editingDiscount = false;
  document.getElementById("modalProductName").innerText = posCart[i].name;
  document.getElementById("modalInput").value = field==="qty" ? posCart[i].quantity : posCart[i].price;
  document.getElementById("editModal").style.display = "flex";
}

//====================================================
// 彈窗 — 編輯折扣
//====================================================
function openDiscountModal(){
  editingDiscount = true;
  editIndex = null;
  document.getElementById("modalProductName").innerText = "輸入折扣金額";
  document.getElementById("modalInput").value = document.getElementById("discount").value || 0;
  document.getElementById("editModal").style.display = "flex";
}

//====================================================
// 數字鍵
//====================================================
function np(v){
  let input = document.getElementById("modalInput");
  if(v==="." && input.value.includes(".")) return;
  input.value = input.value + v;
}
function backspace(){
  let input = document.getElementById("modalInput");
  input.value = input.value.slice(0,-1);
  if(input.value==="") input.value="0";
}

//====================================================
// 確定輸入
//====================================================
function confirmEdit(){
  let v = Number(document.getElementById("modalInput").value) || 0;
  if(editingDiscount){
    document.getElementById("discount").value = v;
  } else if(editingField==="search"){
    renderProducts(null, document.getElementById("modalInput").value);
  } else {
    let item = posCart[editIndex];
    if(editingField==="qty") item.quantity = v;
    else item.price = v;
  }
  closeModal();
  renderCart();
}
function closeModal(){ document.getElementById("editModal").style.display="none"; editingDiscount=false; editIndex=null; }

//====================================================
// 換算成斤
//====================================================
function convertToJin(){
  let v = Number(document.getElementById("modalInput").value) || 0;
  if(v===0){ document.getElementById("modalInput").value="0"; return;}
  if(v<1){ v=v*2; } // 半斤轉斤
  document.getElementById("modalInput").value=v.toFixed(2);
}

//====================================================
// 折扣快捷鍵
//====================================================
function setDiscountRate(rate){
  let total = 0;
  posCart.forEach(item=> total += item.price*item.quantity);
  document.getElementById("discount").value = (total*(1-rate)).toFixed(0);
  renderCart();
}
function clearDiscount(){
  document.getElementById("discount").value = "";
  renderCart();
}

//====================================================
// 稅金
//====================================================
function setTax(type){
  currentTax = type;
  document.querySelectorAll("#taxContainer button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll("#taxContainer button").forEach(b=>{if(b.innerText===type) b.classList.add("active");});
  renderCart();
}

//====================================================
// 現金付款
//====================================================
function openCashModal(){
  editingDiscount = false;
  editingField = "cash";
  document.getElementById("modalProductName").innerText = "收現金額";
  document.getElementById("modalInput").value = document.getElementById("cashInput").value || 0;
  document.getElementById("editModal").style.display = "flex";
}
function confirmEditCash(){
  let cash = Number(document.getElementById("modalInput").value) || 0;
  document.getElementById("cashInput").value = cash.toFixed(0);
  updateChange();
  closeModal();
}
function updateChange(){
  let cash = Number(document.getElementById("cashInput").value) || 0;
  let total = Number(document.getElementById("posTotal").innerText) || 0;
  let change = cash - total;
  document.getElementById("changeOut").innerText = change>=0 ? change.toFixed(0) : "0";
}

//====================================================
// 結帳
//====================================================
document.getElementById("posCheckout").onclick = function(){
  alert("結帳完成，列印中...");
  posCart=[]; document.getElementById("discount").value=""; document.getElementById("cashInput").value=""; renderCart();
}

//====================================================
// 模態框按鈕修改 confirm
//====================================================
document.querySelector(".confirm").onclick = function(){
  if(editingField==="cash") confirmEditCash();
  else confirmEdit();
}
</script>
</body>
</html>

