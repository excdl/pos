<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>專業 POS 系統</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;}
#posApp{display:flex;height:100vh;}
#posCategories{width:15%;background:#eee;padding:10px;overflow-y:auto;}
#posCategories button{width:100%;margin:5px 0;padding:10px;font-size:1em;border:none;border-radius:6px;transition:0.2s;}
#posCategories button.active{background:#7ed6df;color:white;}
#posProducts{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;overflow-y:auto;}
.product-card{background:white;border-radius:8px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;text-align:center;}
.product-card img{width:100%;height:100px;object-fit:cover;border-radius:6px;margin-bottom:5px;}
#posCartContainer{width:25%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;}
#posCart{flex:1;overflow-y:auto;margin-bottom:10px;}
#posCart div{display:flex;justify-content:space-between;margin-bottom:5px;background:#fff;padding:5px;border-radius:6px;}
#posCart div button{background:#ff6b6b;color:white;border:none;border-radius:4px;padding:2px 6px;font-size:0.8em;}
#posCheckout{width:100%;padding:10px;font-size:1.2em;margin-top:5px;background:#27ae60;color:white;border:none;border-radius:6px;}
</style>
</head>
<body>
<div id="posApp">
  <div id="posCategories"><h3>分類</h3></div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
    <h3>訂單明細</h3>
    <select id="posStore"></select>
    <div id="posCart"></div>
    <p>總額: <span id="posTotal">0</span> 元</p>
    <select id="posPayment">
      <option value="現金">現金</option>
      <option value="信用卡">信用卡</option>
      <option value="Line Pay">Line Pay</option>
    </select>
    <button id="posCheckout">結帳列印</button>
  </div>
</div>

<script>
const API_URL = "你的 Apps Script Web App URL";
let products=[], categories=[], posCart=[];

async function fetchStores(){
  const res = await fetch(API_URL+"?action=stores");
  const stores = await res.json();
  const sel = document.getElementById("posStore");
  stores.forEach(s=>{const opt=document.createElement("option"); opt.value=s; opt.textContent=s; sel.appendChild(opt);});
}

async function fetchProducts(){
  const store = document.getElementById("posStore").value;
  const res = await fetch(API_URL+"?action=products&store="+encodeURIComponent(store));
  products = await res.json();
  categories = [...new Set(products.map(p=>p['類別']))].filter(Boolean);
  renderCategories();
  if(categories[0]) renderProducts(categories[0]);
}

function renderCategories(){
  const container = document.getElementById("posCategories");
  container.innerHTML="<h3>分類</h3>";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent=cat;
    btn.onclick=()=>{
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    container.appendChild(btn);
  });
  if(container.querySelector("button")) container.querySelector("button").classList.add("active");
}

function renderProducts(category){
  const container = document.getElementById("posProducts");
  container.innerHTML="";
  products.filter(p=>p['類別']?.trim()===category?.trim()).forEach(p=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p['商品照片']}" alt="${p['商品名稱']}">
      <h4>${p['商品名稱']}</h4>
      <p>${p['售價']} 元</p>
      <p>庫存：${p['庫存']}</p>
      <button onclick='addPOSItem(${JSON.stringify(p)})'>加入訂單</button>
    `;
    container.appendChild(card);
  });
}

function addPOSItem(product){
  const exist = posCart.find(p=>p.name===product['商品名稱']);
  if(exist){ 
    if(exist.quantity+1>product['庫存']) return alert("庫存不足");
    exist.quantity++;
  } else posCart.push({name:product['商品名稱'],price:parseInt(product['售價']),quantity:1,stock:product['庫存']});
  renderPOSCart();
}

function removePOSItem(index){ posCart.splice(index,1); renderPOSCart(); }

function renderPOSCart(){
  const container = document.getElementById("posCart");
  container.innerHTML="";
  let total=0;
  posCart.forEach((item,index)=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;
    const div=document.createElement("div");
    div.innerHTML=`<span>${item.name} x ${item.quantity}</span><span>${subtotal} 元</span><button onclick="removePOSItem(${index})">刪除</button>`;
    container.appendChild(div);
  });
  document.getElementById("posTotal").textContent=total;
}

document.getElementById("posStore").onchange=()=>fetchProducts();

document.getElementById("posCheckout").onclick=async()=>{
  if(posCart.length===0) return alert("沒有商品");
  const store = document.getElementById("posStore").value;
  const data={store,posMachine:"POS01",items:posCart,totalAmount:posCart.reduce((sum,i)=>sum+i.price*i.quantity,0),paymentMethod:document.getElementById("posPayment").value};
  try{
    const res = await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    const result = await res.json();
    if(result.status==="success"){ alert("訂單完成，單號："+result.orderId); posCart=[]; renderPOSCart(); fetchProducts();}
    else alert("結帳失敗："+result.message);
  }catch(e){alert("結帳失敗:"+e);}
}

// 初始化
fetchStores().then(fetchProducts);
</script>
</body>
</html>


