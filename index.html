<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS 生鮮蔬果系統</title>
<style>
body, html{margin:0;padding:0;height:100%;font-family:"Microsoft JhengHei",Arial,sans-serif;overflow:hidden;background:#f5f5f5;}
button{cursor:pointer;outline:none;}
#posApp{display:flex;height:100vh;}

/* 左側分類 */
#posCategories{width:15%;background:#eee;padding:10px;overflow-y:auto;}
#posCategories h3{margin-top:0;}
#posCategories button{width:100%;margin:5px 0;padding:15px;font-size:1.1em;border:none;border-radius:6px;transition:0.2s;}
#posCategories button.active{background:#7ed6df;color:white;}

/* 中間商品區 */
#posProducts{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;overflow-y:auto;}
.product-card{background:white;border-radius:8px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;transition:0.2s;text-align:center;}
.product-card img{width:100%;height:100px;object-fit:cover;border-radius:6px;margin-bottom:5px;transition:0.2s;}
.product-card:hover img{transform:scale(1.05);}
.product-card button{font-size:1em;padding:8px;border:none;border-radius:6px;background:#27ae60;color:white;margin-top:auto;}

/* 右側訂單明細 */
#posCartContainer{width:25%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;}
#posCartContainer h3{margin-top:0;}
#posCart{flex:1;overflow-y:auto;margin-bottom:10px;}
#posCart div{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;background:#fff;padding:5px;border-radius:6px;font-size:1em;}
#posCart div span{margin:0 5px;}
#posCart div button{background:#ff6b6b;color:white;border:none;border-radius:4px;padding:2px 6px;font-size:0.9em;}
.qtyControl{display:flex;align-items:center;gap:5px;}
.qtyControl button{width:28px;height:28px;font-size:1.1em;background:#7ed6df;color:#000;border:none;border-radius:4px;line-height:1;}

/* 結帳按鈕 */
#posCheckout{width:100%;padding:15px;font-size:1.2em;margin-top:5px;background:#27ae60;color:white;border:none;border-radius:6px;}

/* POS 觸控優化 */
#posProducts, #posCartContainer, #posCategories{
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
</style>
</head>
<body>

<div id="posApp">
  <!-- 左側分類 -->
  <div id="posCategories"><h3>分類</h3></div>

  <!-- 中間商品 -->
  <div id="posProducts"></div>

  <!-- 右側訂單明細 -->
  <div id="posCartContainer">
    <h3>訂單明細</h3>
    <div id="posCart"></div>
    <p>總額: <span id="posTotal">0</span> 元</p>
    <select id="posPayment">
      <option value="現金">現金</option>
      <option value="信用卡">信用卡</option>
      <option value="Line Pay">Line Pay</option>
    </select>
    <button id="posCheckout">結帳列印</button>
  </div>
</div>

<script>
const API_URL = "你的 Apps Script Web App URL"; // 後端 App Script Web App URL
let products=[], categories=[], posCart=[];

// 抓取商品並生成分類
async function fetchProducts(){
  try{
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories = [...new Set(products.map(p=>p['類別']))].filter(Boolean);
    renderCategories();
    if(categories[0]) renderProducts(categories[0]);
  }catch(e){ console.error("抓取商品失敗:",e); }
}

// 顯示分類
function renderCategories(){
  const container = document.getElementById("posCategories");
  container.innerHTML="<h3>分類</h3>";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.textContent=cat;
    btn.onclick=()=>{
      document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderProducts(cat);
    };
    container.appendChild(btn);
  });
  if(container.querySelector("button")) container.querySelector("button").classList.add("active");
}

// 顯示商品
function renderProducts(category){
  const container = document.getElementById("posProducts");
  container.innerHTML="";
  products.filter(p=>p['類別']?.trim()===category?.trim()).forEach(p=>{
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p['商品照片']}" alt="${p['商品名稱']}">
      <h4>${p['商品名稱']}</h4>
      <p>${p['售價']} 元</p>
      <button onclick='addPOSItem(${JSON.stringify(p)})'>加入訂單</button>
    `;
    container.appendChild(card);
  });
}

// 加入 POS 訂單
function addPOSItem(product){
  const exist = posCart.find(p=>p.name===product['商品名稱']);
  if(exist) exist.quantity++;
  else posCart.push({name:product['商品名稱'],price:parseInt(product['售價']),quantity:1});
  renderPOSCart();
}

// 刪除訂單商品
function removePOSItem(index){
  posCart.splice(index,1);
  renderPOSCart();
}

// 調整商品數量
function changeQty(index, delta){
  posCart[index].quantity += delta;
  if(posCart[index].quantity<1) posCart[index].quantity=1;
  renderPOSCart();
}

// 渲染訂單明細
function renderPOSCart(){
  const container = document.getElementById("posCart");
  container.innerHTML="";
  let total=0;
  posCart.forEach((item,index)=>{
    const subtotal=item.price*item.quantity;
    total+=subtotal;
    const div = document.createElement("div");
    div.innerHTML=`
      <span>${item.name}</span>
      <span class="qtyControl">
        <button onclick="changeQty(${index},-1)">-</button>
        ${item.quantity}
        <button onclick="changeQty(${index},1)">+</button>
      </span>
      <span>${subtotal} 元</span>
      <button onclick="removePOSItem(${index})">刪除</button>
    `;
    container.appendChild(div);
  });
  document.getElementById("posTotal").textContent=total;
  container.scrollTop = container.scrollHeight;
}

// 結帳列印
document.getElementById("posCheckout").onclick = async function(){
  if(posCart.length===0){ alert("沒有商品"); return; }
  const totalAmount = posCart.reduce((sum,i)=>sum+i.price*i.quantity,0);
  const paymentMethod = document.getElementById("posPayment").value;
  const data = {userName:"店員",totalAmount,paymentMethod,items:posCart};

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    const result = await res.json();
    if(result.success){
      alert("訂單完成，單號：" + result.orderId);
      posCart=[]; renderPOSCart();
    } else alert("列印失敗：" + result.error);
  }catch(e){ alert("結帳失敗:"+e); }
}

// 初始化
fetchProducts();
</script>
</body>
</html>


