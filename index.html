<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ç£ç”Ÿé®® POS ç³»çµ±</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#posApp{display:flex;height:100vh;}
#posCategories{width:18%;background:#3498db;padding:15px;color:white;overflow-y:auto;border-radius:0 12px 12px 0;}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#posProducts{flex:1;padding:15px 0 15px 5%;display:flex;flex-wrap:wrap;gap:15px;justify-content:flex-start;align-content:flex-start;overflow-y:auto;}
.product-card{background:white;border-radius:12px;padding:5px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;flex-direction:column;justify-content:flex-start;text-align:center;transition:0.3s;cursor:pointer;width:120px;height:200px;flex-shrink:0;}
.product-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,0.15);}
.product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;margin-bottom:5px;}
.product-card h4{margin:0;font-size:0.6em;line-height:1.2em;white-space:normal;word-wrap:break-word;max-height:2.4em;overflow:hidden;text-overflow:ellipsis;}
.product-card p{margin:2px 0 0 0;font-size:0.8em;color:#555;}
#posCartContainer{width:25%;background:#f7f7f7;padding:10px;display:flex;flex-direction:column;overflow-y:auto;border-left:2px solid #ddd;min-height:400px;}
.cartHeader{font-weight:bold;background:#eee;white-space:nowrap;font-size:85%;display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;padding:5px;border-radius:6px;}
#posCart div{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;padding:5px;border-radius:6px;background:#fff;transition:0.2s;font-size:0.7em;min-height:40px;}
#posCart div span.name{flex:3;white-space:normal;word-break:break-word;}
#posCart div span.qty,#posCart div span.price,#posCart div span.subtotal,#posCart div span.remove{flex:1.25;text-align:center;}
#posCart div span.price,#posCart div span.subtotal{text-align:right;}
#posCart div span.remove button{padding:2px 6px;font-size:0.7em;border-radius:6px;background:#e74c3c;color:white;border:none;}
#discountContainer,#taxContainer,#paymentContainer{display:flex;gap:5px;margin-top:5px;align-items:center;}
#discount{flex:1;padding:5px;font-size:1em;border:2px solid #ccc;border-radius:6px;text-align:right;}
.payment-btn,.tax-btn{flex:1;padding:8px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;transition:0.2s;}
.payment-btn.active,.tax-btn.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#cashContainer{display:none;flex-direction:column;gap:5px;margin-top:5px;}
#cashContainer input{padding:5px;font-size:1em;border:2px solid #ccc;border-radius:6px;text-align:right;}
#posCheckout{width:100%;padding:12px;font-size:1.2em;margin-top:5px;background:#27ae60;color:white;border:none;border-radius:6px;}
#editModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#editModal .modalContent{background:#fff;padding:20px;border-radius:12px;width:320px;text-align:center;display:flex;flex-direction:column;align-items:center;}
#editModal h4{margin-bottom:10px;}
#editModal input{width:80px;text-align:center;font-size:1.3em;margin:5px;border:2px solid #ccc;border-radius:6px;}
#numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:10px;width:100%;}
#numpad button{padding:15px;font-size:1.2em;background:#3498db;color:white;border:none;border-radius:6px;transition:0.2s;width:100%;}
#numpad button:hover{background:#2980b9;}
.modalActions{display:flex;gap:5px;width:100%;margin-top:5px;}
.modalActions button{flex:1;padding:10px;font-size:1em;border:none;border-radius:6px;}
.modalActions .confirm{background:#27ae60;color:white;}
.modalActions .cancel{background:#e74c3c;color:white;}
.modalActions .convert{background:#f39c12;color:white;}
#checkoutModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#checkoutModal .modalContent{background:#fff;padding:20px;border-radius:12px;width:320px;text-align:left;}
#checkoutModal button{margin-top:10px;padding:8px 12px;border:none;border-radius:6px;background:#27ae60;color:white;}
</style>
</head>
<body>
<div id="posApp">
  <div id="posCategories"><h3>åˆ†é¡</h3></div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
        <!-- å³å´è³¼ç‰©è»Š -->
  <div id="posCartContainer">
    <h3 style="font-size:85%;">è¨‚å–®æ˜ç´°</h3>
    <div class="cartHeader">
      <span style="flex:2.5">å•†å“</span>
      <span style="flex:1">æ•¸é‡</span>
      <span style="flex:1">å–®åƒ¹</span>
      <span style="flex:1">å°è¨ˆ</span>
      <span style="flex:1">åˆªé™¤</span>
    </div>

      <input type="text" id="discount" placeholder="æŠ˜æ‰£" readonly onclick="openDiscountModal()">
      <button class="tax-btn" onclick="setTax('å…ç¨…')">å…ç¨…</button>
      <button class="tax-btn" onclick="setTax('æ‡‰ç¨…')">æ‡‰ç¨…</button>
    </div>
    <p>ç¸½é¡: <span id="posTotal">0</span> å…ƒ</p>
    <div id="paymentContainer">
      <button class="payment-btn active" onclick="setPayment('ç¾é‡‘')">ç¾é‡‘</button>
      <button class="payment-btn" onclick="setPayment('LINEPAY')">LINEPAY</button>
      <button class="payment-btn" onclick="setPayment('ä¿¡ç”¨å¡')">ä¿¡ç”¨å¡</button>
    </div>
    <div id="cashContainer">
      <input type="text" id="cashReceived" readonly onclick="openCashModal()">
      æ‰¾é›¶: <span id="cashChange">0</span>
    </div>
    <button id="posCheckout">çµå¸³åˆ—å°</button>
  </div>
</div>

<div id="editModal">
  <div class="modalContent">
    <h4 id="modalProductName">å•†å“åç¨±</h4>
    <div>
      <label id="modalLabel">æ•¸é‡/å–®åƒ¹:</label>
      <input id="modalInput" type="text" readonly value="1">
    </div>
    <div id="numpad">
      <button onclick="numpadPress('7')">7</button>
      <button onclick="numpadPress('8')">8</button>
      <button onclick="numpadPress('9')">9</button>
      <button onclick="numpadPress('4')">4</button>
      <button onclick="numpadPress('5')">5</button>
      <button onclick="numpadPress('6')">6</button>
      <button onclick="numpadPress('1')">1</button>
      <button onclick="numpadPress('2')">2</button>
      <button onclick="numpadPress('3')">3</button>
      <button onclick="numpadPress('0')">0</button>
      <button onclick="numpadPress('.')">.</button>
      <button onclick="numpadBack()">â†</button>
    </div>
    <div class="modalActions">
      <button class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="convert" onclick="convertScaleToJin()">æ›ç®—æ–¤</button>
      <button class="confirm" onclick="confirmEdit()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<div id="checkoutModal">
  <div class="modalContent">
    <div id="checkoutContent"></div>
    <button onclick="closeCheckoutModal()">ç¢ºèª</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbym4u_bE2-YO1kXyBeSIsYWZBpdG_030NL4BVJcwEnebKGF8BSdFe9rSkjZdAaOU_-H/exec";
let products=[], categories=[], posCart=[];
let editIndex=null, editingField="qty", discountEditing=false;
let paymentMethod="ç¾é‡‘", taxRate=0;

// -------------------- æŠ“å•†å“ --------------------
async function fetchProducts(){
  try{
    const res = await fetch(API_URL+"?action=products");
    products = await res.json();
    categories=[...new Set(products.map(p=>p['é¡åˆ¥']))].filter(Boolean);
    renderCategories();
    if(categories[0]) renderProducts(categories[0]);
  }catch(e){ console.error("æŠ“å–å•†å“å¤±æ•—:",e); }
}
function renderCategories(){
  const container=document.getElementById("posCategories");
  container.innerHTML="<h3>åˆ†é¡</h3>";
  categories.forEach(cat=>{
    const btn=document.createElement("button");
    btn.textContent=cat;
    btn.onclick=()=>{document.querySelectorAll("#posCategories button").forEach(b=>b.classList.remove("active"));btn.classList.add("active");renderProducts(cat);}
    container.appendChild(btn);
  });
  if(container.querySelector("button")) container.querySelector("button").classList.add("active");
}
function renderProducts(category){
  const container=document.getElementById("posProducts");
  container.innerHTML="";
  products.filter(p=>p['é¡åˆ¥']?.trim()===category?.trim()).forEach(p=>{
    const card=document.createElement("div");
    card.className="product-card";
    card.innerHTML=`<img src="${p['å•†å“ç…§ç‰‡']}" alt="${p['å•†å“åç¨±']}"><h4 title="${p['å•†å“åç¨±']}">${p['å•†å“åç¨±']}</h4><p>${p['å”®åƒ¹']} å…ƒ / æ–¤</p>`;
    card.onclick=()=>addPOSItem(p);
    container.appendChild(card);
  });
}

// -------------------- åŠ å…¥è¨‚å–® --------------------
function addPOSItem(product){
  const exist=posCart.find(p=>p.name===product['å•†å“åç¨±']);
  if(exist) exist.quantity+=1;
  else posCart.push({name:product['å•†å“åç¨±'],price:parseFloat(product['å”®åƒ¹']),quantity:1});
  renderPOSCart();
}

// -------------------- é¡¯ç¤ºè¨‚å–® --------------------
function renderPOSCart(){
  const container=document.getElementById("posCart");
  container.innerHTML="";
  let totalAmount=0;
  posCart.forEach((item,index)=>{
    const subtotal=item.price*item.quantity;
    totalAmount+=subtotal;
    const div=document.createElement("div");
    div.innerHTML=`<span class="name">${item.name}</span>
      <span class="qty" onclick="openEditModal(${index},'qty')">${item.quantity.toFixed(2)} æ–¤</span>
      <span class="price" onclick="openEditModal(${index},'price')">${item.price.toFixed(2)}</span>
      <span class="subtotal">${subtotal.toFixed(2)}</span>
      <span class="remove"><button onclick="removePOSItem(${index})">ğŸ—‘</button></span>`;
    container.appendChild(div);
  });
  let disc=parseFloat(document.getElementById("discount").value)||0;
  let totalWithDisc=(totalAmount-disc)*(1+taxRate);
  document.getElementById("posTotal").textContent=totalWithDisc.toFixed(2);
  // æ›´æ–°æ‰¾é›¶
  if(paymentMethod==="ç¾é‡‘"){
    let cash=parseFloat(document.getElementById("cashReceived").value)||0;
    document.getElementById("cashChange").textContent=(cash-totalWithDisc).toFixed(2);
  }
}

// -------------------- ç·¨è¼¯æ¨¡æ…‹ --------------------
function openEditModal(index,field){
  editIndex=index; editingField=field; discountEditing=false;
  const item=posCart[index];
  document.getElementById("modalProductName").textContent=item.name;
  document.getElementById("modalInput").value=field==="qty"?item.quantity:item.price;
  document.getElementById("modalLabel").textContent=field==="qty"?"æ•¸é‡":"å–®åƒ¹";
  document.getElementById("editModal").style.display="flex";
}
function openDiscountModal(){
  editIndex=null; discountEditing=true;
  document.getElementById("modalProductName").textContent="æŠ˜æ‰£é‡‘é¡";
  document.getElementById("modalInput").value=parseFloat(document.getElementById("discount").value)||0;
  document.getElementById("modalLabel").textContent="æŠ˜æ‰£";
  document.getElementById("editModal").style.display="flex";
}
function closeModal(){ document.getElementById("editModal").style.display="none"; renderPOSCart(); }
function numpadPress(char){
  const input=document.getElementById("modalInput");
  if(char==="."&&input.value.includes(".")) return;
  input.value=(input.value==="0"&&char!=="."?char:input.value+char);
}
function numpadBack(){ const input=document.getElementById("modalInput"); input.value=input.value.slice(0,-1)||"0"; }

// -------------------- ç£…ç§¤æ›ç®— --------------------
function convertScaleToJin(){
  let val=parseFloat(document.getElementById("modalInput").value)||0;
  // åŠæ–¤æˆ–å°æ–¼1æ•¸å­—ç›´æ¥ä¿ç•™ç‚ºæ–¤
  if(val<1) val=val; // åŠæ–¤ã€é›¶é»å¹¾æ–¤ç›´æ¥ç•¶æ–¤
  else{
    let intPart=Math.floor(val);
    let decimal=val-intPart;
    val=intPart+decimal*10/16; // å…©éŒ¢æ›ç®—
  }
  document.getElementById("modalInput").value=val.toFixed(2);
}

// -------------------- ç¢ºèªç·¨è¼¯ --------------------
function confirmEdit(){
  let val=parseFloat(document.getElementById("modalInput").value)||0;
  if(discountEditing){
    document.getElementById("discount").value=val;
  }else if(editingField==="qty"){
    posCart[editIndex].quantity=val;
  }else{
    posCart[editIndex].price=val;
  }
  closeModal();
}

// -------------------- ç§»é™¤å•†å“ --------------------
function removePOSItem(index){ posCart.splice(index,1); renderPOSCart(); }

// -------------------- ç¨…é‡‘ --------------------
function setTax(type){ taxRate=(type==="æ‡‰ç¨…")?0.05:0; document.querySelectorAll(".tax-btn").forEach(b=>b.classList.remove("active")); event.target.classList.add("active"); renderPOSCart(); }

// -------------------- ä»˜æ¬¾æ–¹å¼ --------------------
function setPayment(method){ paymentMethod=method; document.querySelectorAll(".payment-btn").forEach(b=>b.classList.remove("active")); event.target.classList.add("active"); document.getElementById("cashContainer").style.display=(method==="ç¾é‡‘")?"flex":"none"; renderPOSCart(); }
function openCashModal(){ editingField="cash"; discountEditing=false; editIndex=null; document.getElementById("modalProductName").textContent="ç¾é‡‘æ”¶å…¥"; document.getElementById("modalInput").value=document.getElementById("cashReceived").value||0; document.getElementById("modalLabel").textContent="ç¾é‡‘æ”¶å…¥"; document.getElementById("editModal").style.display="flex"; }
function confirmEdit(){ 
  let val=parseFloat(document.getElementById("modalInput").value)||0;
  if(editingField==="cash") document.getElementById("cashReceived").value=val;
  else if(discountEditing) document.getElementById("discount").value=val;
  else if(editingField==="qty") posCart[editIndex].quantity=val;
  else posCart[editIndex].price=val;
  closeModal();
}

// -------------------- çµå¸³ --------------------
document.getElementById("posCheckout").onclick=function(){
  const total=parseFloat(document.getElementById("posTotal").textContent)||0;
  let cash=parseFloat(document.getElementById("cashReceived").value)||0;
  let change=(paymentMethod==="ç¾é‡‘")?(cash-total).toFixed(2):"0.00";
  let content=`<h3>çµå¸³æ˜ç´°</h3><hr>`;
  posCart.forEach(item=>{
    content+=`${item.name} Ã— ${item.quantity.toFixed(2)} æ–¤ Ã— ${item.price.toFixed(2)} = ${(item.quantity*item.price).toFixed(2)}<br>`;
  });
  content+=`<hr>æŠ˜æ‰£: ${document.getElementById("discount").value||0}<br>`;
  content+=`ç¨…é‡‘: ${(taxRate*100).toFixed(0)}%<br>`;
  content+=`ç¸½é¡: ${total.toFixed(2)}<br>`;
  content+=`ä»˜æ¬¾æ–¹å¼: ${paymentMethod}<br>`;
  if(paymentMethod==="ç¾é‡‘"){
    content+=`ç¾é‡‘æ”¶å…¥: ${cash.toFixed(2)}<br>`;
    content+=`æ‰¾é›¶: ${change}<br>`;
  }
  document.getElementById("checkoutContent").innerHTML=content;
  document.getElementById("checkoutModal").style.display="flex";
};
function closeCheckoutModal(){
  document.getElementById("checkoutModal").style.display="none";
  posCart=[]; renderPOSCart(); document.getElementById("discount").value=""; document.getElementById("cashReceived").value=""; document.getElementById("cashChange").textContent="0";
}

// -------------------- åˆå§‹åŒ– --------------------
fetchProducts();
</script>
</body>
</html>







